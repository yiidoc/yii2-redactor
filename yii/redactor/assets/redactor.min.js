(function(d){var b=0;var a=false;"use strict";var e=function(f){this[0]=f.startOffset;this[1]=f.endOffset;this.range=f;return this};e.prototype.equals=function(){return this[0]===this[1]};d.fn.redactor=function(g){var h=[];var f=Array.prototype.slice.call(arguments,1);if(typeof g==="string"){this.each(function(){var j=d.data(this,"redactor");if(typeof j!=="undefined"&&d.isFunction(j[g])){var i=j[g].apply(j,f);if(i!==undefined&&i!==j){h.push(i)}}else{return d.error('No such method "'+g+'" for Redactor')}})}else{this.each(function(){if(!d.data(this,"redactor")){d.data(this,"redactor",c(this,g))}})}if(h.length===0){return this}else{if(h.length===1){return h[0]}else{return h}}};function c(g,f){return new c.prototype.init(g,f)}d.Redactor=c;d.Redactor.VERSION="9.1.0";d.Redactor.opts={rangy:false,iframe:false,fullpage:false,css:false,lang:"en",direction:"ltr",placeholder:false,wym:false,mobile:true,cleanup:true,pastePlainText:false,removeEmptyTags:true,templateVars:false,visual:true,focus:false,tabindex:false,autoresize:true,minHeight:false,shortcuts:true,autosave:false,autosaveInterval:60,plugins:false,linkAnchor:false,linkEmail:false,linkProtocol:"http://",linkNofollow:false,imageGetJson:false,imageUpload:false,fileUpload:false,clipboardUpload:true,clipboardUploadUrl:false,dragUpload:true,dnbImageTypes:["image/png","image/jpeg","image/gif"],s3:false,uploadFields:false,observeImages:true,modalOverlay:true,tabFocus:true,air:false,airButtons:["formatting","|","bold","italic","deleted","|","unorderedlist","orderedlist","outdent","indent","|","fontcolor","backcolor"],toolbar:true,toolbarFixed:false,toolbarFixedTarget:document,toolbarFixedTopOffset:0,toolbarFixedBox:false,toolbarExternal:false,buttonSource:true,buttonSeparator:'<li class="redactor_separator"></li>',buttonsCustom:{},buttonsAdd:[],buttons:["html","|","formatting","|","bold","italic","deleted","|","unorderedlist","orderedlist","outdent","indent","|","image","video","file","table","link","|","fontcolor","backcolor","|","alignment","|","horizontalrule"],colors:["#ffffff","#000000","#eeece1","#1f497d","#4f81bd","#c0504d","#9bbb59","#8064a2","#4bacc6","#f79646","#ffff00","#f2f2f2","#7f7f7f","#ddd9c3","#c6d9f0","#dbe5f1","#f2dcdb","#ebf1dd","#e5e0ec","#dbeef3","#fdeada","#fff2ca","#d8d8d8","#595959","#c4bd97","#8db3e2","#b8cce4","#e5b9b7","#d7e3bc","#ccc1d9","#b7dde8","#fbd5b5","#ffe694","#bfbfbf","#3f3f3f","#938953","#548dd4","#95b3d7","#d99694","#c3d69b","#b2a2c7","#b7dde8","#fac08f","#f2c314","#a5a5a5","#262626","#494429","#17365d","#366092","#953734","#76923c","#5f497a","#92cddc","#e36c09","#c09100","#7f7f7f","#0c0c0c","#1d1b10","#0f243e","#244061","#632423","#4f6128","#3f3151","#31859b","#974806","#7f6000"],activeButtons:["deleted","italic","bold","underline","unorderedlist","orderedlist","alignleft","aligncenter","alignright","justify","table"],activeButtonsStates:{b:"bold",strong:"bold",i:"italic",em:"italic",del:"deleted",strike:"deleted",ul:"unorderedlist",ol:"orderedlist",u:"underline",tr:"table",td:"table",table:"table"},activeButtonsAdd:false,formattingTags:["p","blockquote","pre","h1","h2","h3","h4","h5","h6"],linebreaks:false,paragraphy:true,convertDivs:true,convertLinks:true,convertImageLinks:false,convertVideoLinks:false,formattingPre:false,phpTags:false,allowedTags:false,deniedTags:["html","head","link","body","meta","script","style","applet"],boldTag:"strong",italicTag:"em",indentValue:20,buffer:[],rebuffer:[],textareamode:false,emptyHtml:"<p>&#x200b;</p>",invisibleSpace:"&#x200b;",rBlockTest:/^(P|H[1-6]|LI|ADDRESS|SECTION|HEADER|FOOTER|ASIDE|ARTICLE)$/i,alignmentTags:["P","H1","H2","H3","H4","H5","H6","DD","DL","DT","DIV","TD","BLOCKQUOTE","OUTPUT","FIGCAPTION","ADDRESS","SECTION","HEADER","FOOTER","ASIDE","ARTICLE"],ownLine:["area","body","head","hr","i?frame","link","meta","noscript","style","script","table","tbody","thead","tfoot"],contOwnLine:["li","dt","dt","h[1-6]","option","script"],newLevel:["blockquote","div","dl","fieldset","form","frameset","map","ol","p","pre","select","td","th","tr","ul"],blockLevelElements:["P","H1","H2","H3","H4","H5","H6","DD","DL","DT","DIV","LI","BLOCKQUOTE","OUTPUT","FIGCAPTION","PRE","ADDRESS","SECTION","HEADER","FOOTER","ASIDE","ARTICLE"],langs:{en:{html:"HTML",video:"Insert Video",image:"Insert Image",table:"Table",link:"Link",link_insert:"Insert link",link_edit:"Edit link",unlink:"Unlink",formatting:"Formatting",paragraph:"Normal text",quote:"Quote",code:"Code",header1:"Header 1",header2:"Header 2",header3:"Header 3",header4:"Header 4",header5:"Header 5",bold:"Bold",italic:"Italic",fontcolor:"Font Color",backcolor:"Back Color",unorderedlist:"Unordered List",orderedlist:"Ordered List",outdent:"Outdent",indent:"Indent",cancel:"Cancel",insert:"Insert",save:"Save",_delete:"Delete",insert_table:"Insert Table",insert_row_above:"Add Row Above",insert_row_below:"Add Row Below",insert_column_left:"Add Column Left",insert_column_right:"Add Column Right",delete_column:"Delete Column",delete_row:"Delete Row",delete_table:"Delete Table",rows:"Rows",columns:"Columns",add_head:"Add Head",delete_head:"Delete Head",title:"Title",image_position:"Position",none:"None",left:"Left",right:"Right",image_web_link:"Image Web Link",text:"Text",mailto:"Email",web:"URL",video_html_code:"Video Embed Code",file:"Insert File",upload:"Upload",download:"Download",choose:"Choose",or_choose:"Or choose",drop_file_here:"Drop file here",align_left:"Align text to the left",align_center:"Center text",align_right:"Align text to the right",align_justify:"Justify text",horizontalrule:"Insert Horizontal Rule",deleted:"Deleted",anchor:"Anchor",link_new_tab:"Open link in new tab",underline:"Underline",alignment:"Alignment",filename:"Name (optional)",edit:"Edit"}}};c.fn=d.Redactor.prototype={keyCode:{BACKSPACE:8,DELETE:46,DOWN:40,ENTER:13,ESC:27,TAB:9,CTRL:17,META:91,LEFT:37,LEFT_WIN:91},init:function(g,f){this.$element=this.$source=d(g);this.uuid=b++;this.opts=d.extend({},d.Redactor.opts,this.$element.data(),f);this.start=true;this.dropdowns=[];this.sourceHeight=this.$source.css("height");this.sourceWidth=this.$source.css("width");if(this.opts.fullpage){this.opts.iframe=true}if(this.opts.linebreaks){this.opts.paragraphy=false}if(this.opts.paragraphy){this.opts.linebreaks=false}if(this.opts.toolbarFixedBox){this.opts.toolbarFixed=true}this.document=document;this.window=window;this.savedSel=false;this.cleanlineBefore=new RegExp("^<(/?"+this.opts.ownLine.join("|/?")+"|"+this.opts.contOwnLine.join("|")+")[ >]");this.cleanlineAfter=new RegExp("^<(br|/?"+this.opts.ownLine.join("|/?")+"|/"+this.opts.contOwnLine.join("|/")+")[ >]");this.cleannewLevel=new RegExp("^</?("+this.opts.newLevel.join("|")+")[ >]");this.rTestBlock=new RegExp("^("+this.opts.blockLevelElements.join("|")+")$","i");if(this.opts.linebreaks===false){if(this.opts.allowedTags!==false&&d.inArray("p",this.opts.allowedTags)==="-1"){this.opts.allowedTags.push("p")}if(this.opts.deniedTags!==false){var h=d.inArray("p",this.opts.deniedTags);if(h!=="-1"){this.opts.deniedTags.splice(h,h)}}}if(this.browser("msie")||this.browser("opera")){this.opts.buttons=this.removeFromArrayByValue(this.opts.buttons,"horizontalrule")}this.opts.curLang=this.opts.langs[this.opts.lang];this.buildStart()},initToolbar:function(f){return{html:{title:f.html,func:"toggle"},formatting:{title:f.formatting,func:"show",dropdown:{p:{title:f.paragraph,func:"formatBlocks"},blockquote:{title:f.quote,func:"formatQuote",className:"redactor_format_blockquote"},pre:{title:f.code,func:"formatBlocks",className:"redactor_format_pre"},h1:{title:f.header1,func:"formatBlocks",className:"redactor_format_h1"},h2:{title:f.header2,func:"formatBlocks",className:"redactor_format_h2"},h3:{title:f.header3,func:"formatBlocks",className:"redactor_format_h3"},h4:{title:f.header4,func:"formatBlocks",className:"redactor_format_h4"},h5:{title:f.header5,func:"formatBlocks",className:"redactor_format_h5"}}},bold:{title:f.bold,exec:"bold"},italic:{title:f.italic,exec:"italic"},deleted:{title:f.deleted,exec:"strikethrough"},underline:{title:f.underline,exec:"underline"},unorderedlist:{title:"&bull; "+f.unorderedlist,exec:"insertunorderedlist"},orderedlist:{title:"1. "+f.orderedlist,exec:"insertorderedlist"},outdent:{title:"< "+f.outdent,func:"indentingOutdent"},indent:{title:"> "+f.indent,func:"indentingIndent"},image:{title:f.image,func:"imageShow"},video:{title:f.video,func:"videoShow"},file:{title:f.file,func:"fileShow"},table:{title:f.table,func:"show",dropdown:{insert_table:{title:f.insert_table,func:"tableShow"},separator_drop1:{name:"separator"},insert_row_above:{title:f.insert_row_above,func:"tableAddRowAbove"},insert_row_below:{title:f.insert_row_below,func:"tableAddRowBelow"},insert_column_left:{title:f.insert_column_left,func:"tableAddColumnLeft"},insert_column_right:{title:f.insert_column_right,func:"tableAddColumnRight"},separator_drop2:{name:"separator"},add_head:{title:f.add_head,func:"tableAddHead"},delete_head:{title:f.delete_head,func:"tableDeleteHead"},separator_drop3:{name:"separator"},delete_column:{title:f.delete_column,func:"tableDeleteColumn"},delete_row:{title:f.delete_row,func:"tableDeleteRow"},delete_table:{title:f.delete_table,func:"tableDeleteTable"}}},link:{title:f.link,func:"show",dropdown:{link:{title:f.link_insert,func:"linkShow"},unlink:{title:f.unlink,exec:"unlink"}}},fontcolor:{title:f.fontcolor,func:"show"},backcolor:{title:f.backcolor,func:"show"},alignment:{title:f.alignment,func:"show",dropdown:{alignleft:{title:f.align_left,func:"alignmentLeft"},aligncenter:{title:f.align_center,func:"alignmentCenter"},alignright:{title:f.align_right,func:"alignmentRight"},justify:{title:f.align_justify,func:"alignmentJustify"}}},alignleft:{title:f.align_left,func:"alignmentLeft"},aligncenter:{title:f.align_center,func:"alignmentCenter"},alignright:{title:f.align_right,func:"alignmentRight"},justify:{title:f.align_justify,func:"alignmentJustify"},horizontalrule:{exec:"inserthorizontalrule",title:f.horizontalrule}}},callback:function(f,g,h){var i=this.opts[f+"Callback"];if(d.isFunction(i)){if(g===false){return i.call(this,h)}else{return i.call(this,g,h)}}else{return h}},destroy:function(){clearInterval(this.autosaveInterval);d(window).off(".redactor");this.$element.off(".redactor").removeData("redactor");var g=this.get();if(this.opts.textareamode){this.$box.after(this.$source);this.$box.remove();this.$source.val(g).show()}else{var f=this.$editor;if(this.opts.iframe){f=this.$element}this.$box.after(f);this.$box.remove();f.removeClass("redactor_editor").removeClass("redactor_editor_wym").removeAttr("contenteditable").html(g).show()}if(this.opts.air){d(".redactor_air").remove()}},getObject:function(){return d.extend({},this)},getEditor:function(){return this.$editor},getBox:function(){return this.$box},getIframe:function(){return(this.opts.iframe)?this.$frame:false},getToolbar:function(){return this.$toolbar},get:function(){return this.$source.val()},getCodeIframe:function(){this.$editor.removeAttr("contenteditable").removeAttr("dir");var f=this.outerHtml(this.$frame.contents().children());this.$editor.attr({contenteditable:true,dir:this.opts.direction});return f},set:function(f,g,h){f=f.toString();if(this.opts.fullpage){this.setCodeIframe(f)}else{this.setEditor(f,g)}if(h!==false){this.placeholderRemove()}},setEditor:function(f,g){if(g!==false){f=this.cleanSavePreCode(f);f=this.cleanStripTags(f);f=this.cleanConvertProtected(f);f=this.cleanConvertInlineTags(f);if(this.opts.linebreaks===false){f=this.cleanConverters(f)}else{f=f.replace(/<p(.*?)>([\w\W]*?)<\/p>/gi,"$2<br>")}}f=this.cleanEmpty(f);this.$editor.html(f);this.sync()},setCodeIframe:function(f){var g=this.iframePage();this.$frame[0].src="about:blank";f=this.cleanConvertProtected(f);f=this.cleanConvertInlineTags(f);f=this.cleanRemoveSpaces(f);g.open();g.write(f);g.close();if(this.opts.fullpage){this.$editor=this.$frame.contents().find("body").attr({contenteditable:true,dir:this.opts.direction})}this.sync()},setFullpageOnInit:function(f){f=this.cleanSavePreCode(f,true);f=this.cleanConverters(f);f=this.cleanEmpty(f);this.$editor.html(f);this.sync()},sync:function(){var f="";this.cleanUnverified();if(this.opts.fullpage){f=this.getCodeIframe()}else{f=this.$editor.html()}f=this.syncClean(f);f=this.cleanRemoveSpaces(f);f=this.cleanRemoveEmptyTags(f);f=f.replace(/<\/li><(ul|ol)>([\w\W]*?)<\/(ul|ol)>/gi,"<$1>$2</$1></li>");if(d.trim(f)==="<br>"){f=""}if(f!==""){f=this.cleanHtml(f)}f=this.callback("syncBefore",false,f);this.$source.val(f);this.callback("syncAfter",false,f);if(this.start===false){this.callback("change",false,f)}},syncClean:function(f){if(!this.opts.fullpage){f=this.cleanStripTags(f)}f=d.trim(f);f=this.placeholderRemoveFromCode(f);f=f.replace(/&#x200b;/gi,"");f=f.replace(/&#8203;/gi,"");f=f.replace(/&nbsp;/gi," ");if(this.opts.linkNofollow){f=f.replace(/<a(.*?)rel="nofollow"(.*?)>/gi,"<a$1$2>");f=f.replace(/<a(.*?)>/gi,'<a$1 rel="nofollow">')}f=f.replace("<!--?php","<?php");f=f.replace("?-->","?>");f=f.replace(/ data-tagblock=""/gi,"");f=f.replace(/<br\s?\/?>\n?<\/(P|H[1-6]|LI|ADDRESS|SECTION|HEADER|FOOTER|ASIDE|ARTICLE)>/gi,"</$1>");f=f.replace(/<span(.*?)id="redactor-image-box"(.*?)>([\w\W]*?)<img(.*?)><\/span>/i,"$3<img$4>");f=f.replace(/<span(.*?)id="redactor-image-resizer"(.*?)>(.*?)<\/span>/i,"");f=f.replace(/<span(.*?)id="redactor-image-editter"(.*?)>(.*?)<\/span>/i,"");f=f.replace(/<span\s*?>([\w\W]*?)<\/span>/gi,"$1");f=f.replace(/<span(.*?)data-redactor="verified"(.*?)>([\w\W]*?)<\/span>/gi,"<span$1$2>$3</span>");f=f.replace(/<span(.*?)data-redactor-inlineMethods=""(.*?)>([\w\W]*?)<\/span>/gi,"<span$1$2>$3</span>");f=f.replace(/<span\s*?>([\w\W]*?)<\/span>/gi,"$1");f=f.replace(/<span\s*?id="selection-marker(.*?)"(.*?)>([\w\W]*?)<\/span>/gi,"");f=f.replace(/<span\s*?>([\w\W]*?)<\/span>/gi,"$1");f=f.replace(/<span>([\w\W]*?)<\/span>/gi,"$1");f=this.cleanReConvertProtected(f);return f},buildStart:function(){this.content="";this.$box=d('<div class="redactor_box" />');if(this.$source[0].tagName==="TEXTAREA"){this.opts.textareamode=true}if(this.opts.mobile===false&&this.isMobile()){this.buildMobile()}else{this.buildContent();if(this.opts.iframe){this.opts.autoresize=false;this.iframeStart()}else{if(this.opts.textareamode){this.buildFromTextarea()}else{this.buildFromElement()}}if(!this.opts.iframe){this.buildOptions();this.buildAfter()}}},buildMobile:function(){if(!this.opts.textareamode){this.$editor=this.$source;this.$editor.hide();this.$source=this.buildCodearea(this.$editor);this.$source.val(this.content)}this.$box.insertAfter(this.$source).append(this.$source)},buildContent:function(){if(this.opts.textareamode){this.content=d.trim(this.$source.val())}else{this.content=d.trim(this.$source.html())}},buildFromTextarea:function(){this.$editor=d("<div />");this.$box.insertAfter(this.$source).append(this.$editor).append(this.$source);this.buildAddClasses(this.$editor);this.buildEnable()},buildFromElement:function(){this.$editor=this.$source;this.$source=this.buildCodearea(this.$editor);this.$box.insertAfter(this.$editor).append(this.$editor).append(this.$source);this.buildEnable()},buildCodearea:function(f){return d("<textarea />").attr("name",f.attr("id")).css("height",this.sourceHeight)},buildAddClasses:function(f){d.each(this.$source.get(0).className.split(/\s+/),function(g,h){f.addClass("redactor_"+h)})},buildEnable:function(){this.$editor.addClass("redactor_editor").attr({contenteditable:true,dir:this.opts.direction});this.$source.attr("dir",this.opts.direction).hide();this.set(this.content,true,false)},buildOptions:function(){var f=this.$editor;if(this.opts.iframe){f=this.$frame}if(this.opts.tabindex){f.attr("tabindex",this.opts.tabindex)}if(this.opts.minHeight){f.css("min-height",this.opts.minHeight+"px")}if(this.opts.wym){this.$editor.addClass("redactor_editor_wym")}if(!this.opts.autoresize){f.css("height",this.sourceHeight)}},buildAfter:function(){this.start=false;if(this.opts.toolbar){this.opts.toolbar=this.initToolbar(this.opts.curLang);this.toolbarBuild()}this.modalTemplatesInit();this.buildPlugins();this.buildBindKeyboard();if(this.opts.autosave){this.autosave()}setTimeout(d.proxy(this.observeStart,this),4);if(this.browser("mozilla")){try{this.document.execCommand("enableObjectResizing",false,false);this.document.execCommand("enableInlineTableEditing",false,false)}catch(f){}}if(this.opts.focus){setTimeout(d.proxy(this.focus,this),100)}if(!this.opts.visual){setTimeout(d.proxy(function(){this.opts.visual=true;this.toggle(false)},this),200)}this.callback("init")},buildBindKeyboard:function(){if(this.opts.dragUpload){this.$editor.on("drop.redactor",d.proxy(this.buildEventDrop,this))}this.$editor.on("paste.redactor",d.proxy(this.buildEventPaste,this));this.$editor.on("keydown.redactor",d.proxy(this.buildEventKeydown,this));this.$editor.on("keyup.redactor",d.proxy(this.buildEventKeyup,this));if(d.isFunction(this.opts.focusCallback)){this.$editor.on("focus.redactor",d.proxy(this.opts.focusCallback,this))}if(d.isFunction(this.opts.blurCallback)){this.$editor.on("blur.redactor",d.proxy(this.opts.blurCallback,this))}},buildEventDrop:function(l){l=l.originalEvent||l;if(window.FormData===undefined){return true}var j=l.dataTransfer.files.length;if(j==0){return true}l.preventDefault();var i=l.dataTransfer.files[0];if(this.opts.dnbImageTypes!==false&&this.opts.dnbImageTypes.indexOf(i.type)==-1){return true}this.bufferSet();var h=d("<img>");var f=d('<div id="redactor-progress-drag" class="redactor-progress redactor-progress-striped"><div id="redactor-progress-bar" class="redactor-progress-bar" style="width: 100%;"></div></div>');d(document.body).append(f);var g=new FormData();g.append("file",i);d.ajax({url:this.opts.imageUpload,dataType:"html",data:g,cache:false,contentType:false,processData:false,type:"POST",success:d.proxy(function(n){f.fadeOut("slow",function(){d(this).remove()});var m=d.parseJSON(n);h.attr("src",m.filelink).attr("id","drag-image-marker");this.insertNodeToCaretPositionFromPoint(l,h[0]);var o=d(this.$editor.find("img#drag-image-marker"));if(o.length){o.removeAttr("id")}else{o=false}this.sync();this.observeImages();if(o){this.callback("imageUpload",o,m)}},this),error:d.proxy(function(m){this.callback("imageUploadError",m)},this)})},buildEventPaste:function(g){var h=false;if(this.browser("webkit")&&navigator.userAgent.indexOf("Chrome")===-1){var f=this.browser("version").split(".");if(f[0]<536){h=true}}if(h){return true}if(this.browser("opera")){return true}if(this.opts.clipboardUpload&&this.buildEventClipboardUpload(g)){return true}if(this.opts.cleanup){a=true;this.selectionSave();if(!this.selectall){if(this.opts.autoresize===true){this.$editor.height(this.$editor.height());this.saveScroll=this.document.body.scrollTop}else{this.saveScroll=this.$editor.scrollTop()}}var i=this.extractContent();setTimeout(d.proxy(function(){var j=this.extractContent();this.$editor.append(i);this.selectionRestore();var l=this.getFragmentHtml(j);this.pasteClean(l);if(this.opts.autoresize===true){this.$editor.css("height","auto")}},this),1)}},buildEventClipboardUpload:function(i){var h=i.originalEvent||i;this.clipboardFilePaste=false;if(h.clipboardData.items){var g=h.clipboardData.items[0].getAsFile();if(g!==null){this.bufferSet();this.clipboardFilePaste=true;var f=new FileReader();f.onload=d.proxy(this.pasteClipboardUpload,this);f.readAsDataURL(g);return true}}return false},buildEventKeydown:function(l){if(a){return false}var p=l.which;var f=l.ctrlKey||l.metaKey;var o=this.getParent();var m=this.getCurrent();var i=this.getBlock();var h=false;this.callback("keydown",l);this.imageResizeHide(false);if((o&&d(o).get(0).tagName==="PRE")||(m&&d(m).get(0).tagName==="PRE")){h=true;if(p===this.keyCode.DOWN){this.insertAfterLastElement(i)}}if(p===this.keyCode.DOWN){if(o&&d(o).get(0).tagName==="BLOCKQUOTE"){this.insertAfterLastElement(o)}if(m&&d(m).get(0).tagName==="BLOCKQUOTE"){this.insertAfterLastElement(m)}}if(f&&!l.shiftKey){this.shortcuts(l,p)}if(f&&p===90&&!l.shiftKey&&!l.altKey){l.preventDefault();if(this.opts.buffer.length){this.bufferUndo()}else{this.document.execCommand("undo",false,false)}return}else{if(f&&p===90&&l.shiftKey&&!l.altKey){l.preventDefault();if(this.opts.rebuffer.length!=0){this.bufferRedo()}else{this.document.execCommand("redo",false,false)}return}}if(f&&p===65){this.selectall=true}else{if(p!=this.keyCode.LEFT_WIN&&!f){this.selectall=false}}if(p==this.keyCode.ENTER&&!l.shiftKey&&!l.ctrlKey&&!l.metaKey){if(o.nodeType==1&&(o.tagName=="TD"||o.tagName=="TH")){l.preventDefault();this.bufferSet();this.insertNode(document.createElement("br"));this.callback("enter",l);return false}if(h===true){l.preventDefault();this.bufferSet();var j=d(m).parent().text();this.insertNode(document.createTextNode("\n"));if(j.search(/\s$/)==-1){this.insertNode(document.createTextNode("\n"))}this.sync();this.callback("enter",l);return false}else{if(!this.opts.linebreaks){if(i&&this.opts.rBlockTest.test(i.tagName)){this.bufferSet();setTimeout(d.proxy(function(){var r=this.getBlock();if(r.tagName==="DIV"&&!d(r).hasClass("redactor_editor")){var q=d("<p>"+this.opts.invisibleSpace+"</p>");d(r).replaceWith(q);this.selectionStart(q)}},this),1)}else{if(i===false){this.bufferSet();var g=d("<p>"+this.opts.invisibleSpace+"</p>");this.insertNode(g[0]);this.selectionStart(g);this.callback("enter",l);return false}}}if(this.opts.linebreaks){if(i&&this.opts.rBlockTest.test(i.tagName)){this.bufferSet();setTimeout(d.proxy(function(){var q=this.getBlock();if((q.tagName==="DIV"||q.tagName==="P")&&!d(q).hasClass("redactor_editor")){this.replaceLineBreak(q)}},this),1)}else{return this.buildEventKeydownInsertLineBreak(l)}}if(i.tagName=="BLOCKQUOTE"||i.tagName=="FIGCAPTION"){return this.buildEventKeydownInsertLineBreak(l)}}this.callback("enter",l)}else{if(p===this.keyCode.ENTER&&(l.ctrlKey||l.shiftKey)){this.bufferSet();l.preventDefault();this.insertLineBreak()}}if(p===this.keyCode.TAB&&this.opts.shortcuts){if(!this.opts.tabFocus){return true}if(this.isEmpty(this.get())){return true}l.preventDefault();if(h===true&&!l.shiftKey){this.bufferSet();this.insertNode(document.createTextNode("\t"));this.sync();return false}else{if(!l.shiftKey){this.indentingIndent()}else{this.indentingOutdent()}}return false}if(p===this.keyCode.BACKSPACE){if(typeof m.tagName!=="undefined"&&/^(H[1-6])$/i.test(m.tagName)){var g;if(this.opts.linebreaks===false){g=d("<p>"+this.opts.invisibleSpace+"</p>")}else{g=d("<br>"+this.opts.invisibleSpace)}d(m).replaceWith(g);this.selectionStart(g)}if(typeof m.nodeValue!=="undefined"&&m.nodeValue!==null){var n=d.trim(m.nodeValue.replace(/[^\u0000-~]/g,""));if(m.remove&&m.nodeType===3&&m.nodeValue.charCodeAt(0)==8203&&n==""){m.remove()}}}},buildEventKeydownInsertLineBreak:function(f){this.bufferSet();f.preventDefault();this.insertLineBreak();this.callback("enter",f);return},buildEventKeyup:function(l){if(a){return false}var f=l.which;var h=this.getParent();var j=this.getCurrent();if(!this.opts.linebreaks&&j.nodeType==3&&(h==false||h.tagName=="BODY")){var i=d("<p>").append(d(j).clone());d(j).replaceWith(i);var g=d(i).next();if(typeof(g[0])!=="undefined"&&g[0].tagName=="BR"){g.remove()}this.selectionEnd(i)}if((this.opts.convertLinks||this.opts.convertImageLinks||this.opts.convertVideoLinks)&&f===this.keyCode.ENTER){this.formatLinkify(this.opts.linkProtocol,this.opts.convertLinks,this.opts.convertImageLinks,this.opts.convertVideoLinks);if(this.opts.convertImageLinks){this.observeImages()}}if(this.opts.linebreaks===false&&(f===this.keyCode.DELETE||f===this.keyCode.BACKSPACE)){return this.formatEmpty(l)}this.callback("keyup",l);this.sync()},buildPlugins:function(){if(!this.opts.plugins){return}d.each(this.opts.plugins,d.proxy(function(f,g){if(RedactorPlugins[g]){d.extend(this,RedactorPlugins[g]);if(d.isFunction(RedactorPlugins[g].init)){this.init()}}},this))},iframeStart:function(){this.iframeCreate();if(this.opts.textareamode){this.iframeAppend(this.$source)}else{this.$sourceOld=this.$source.hide();this.$source=this.buildCodearea(this.$sourceOld);this.iframeAppend(this.$sourceOld)}},iframeAppend:function(f){this.$source.attr("dir",this.opts.direction).hide();this.$box.insertAfter(f).append(this.$frame).append(this.$source)},iframeCreate:function(){this.$frame=d('<iframe style="width: 100%;" frameborder="0" />').one("load",d.proxy(function(){if(this.opts.fullpage){this.iframePage();if(this.content===""){this.content=this.opts.invisibleSpace}this.$frame.contents()[0].write(this.content);this.$frame.contents()[0].close();var f=setInterval(d.proxy(function(){if(this.$frame.contents().find("body").html()){clearInterval(f);this.iframeLoad()}},this),0)}else{this.iframeLoad()}},this))},iframeDoc:function(){return this.$frame[0].contentWindow.document},iframePage:function(){var f=this.iframeDoc();if(f.documentElement){f.removeChild(f.documentElement)}return f},iframeAddCss:function(f){f=f||this.opts.css;if(this.isString(f)){this.$frame.contents().find("head").append('<link rel="stylesheet" href="'+f+'" />')}if(d.isArray(f)){d.each(f,d.proxy(function(h,g){this.iframeAddCss(g)},this))}},iframeLoad:function(){this.$editor=this.$frame.contents().find("body").attr({contenteditable:true,dir:this.opts.direction});if(this.$editor[0]){this.document=this.$editor[0].ownerDocument;this.window=this.document.defaultView||window}this.iframeAddCss();if(this.opts.fullpage){this.setFullpageOnInit(this.$editor.html())}else{this.set(this.content,true,false)}this.buildOptions();this.buildAfter()},placeholderStart:function(f){if(this.isEmpty(f)){if(this.$element.attr("placeholder")){this.opts.placeholder=this.$element.attr("placeholder")}if(this.opts.placeholder===""){this.opts.placeholder=false}if(this.opts.placeholder!==false){this.opts.focus=false;this.$editor.one("focus.redactor_placeholder",d.proxy(this.placeholderFocus,this));return d('<span class="redactor_placeholder" data-redactor="verified">').attr("contenteditable",false).text(this.opts.placeholder)}}return false},placeholderFocus:function(){this.$editor.find("span.redactor_placeholder").remove();var f="";if(this.opts.linebreaks===false){f=this.opts.emptyHtml}this.$editor.off("focus.redactor_placeholder");this.$editor.html(f);if(this.opts.linebreaks===false){this.selectionStart(this.$editor.children()[0])}this.sync()},placeholderRemove:function(){this.opts.placeholder=false;this.$editor.find("span.redactor_placeholder").remove();this.$editor.off("focus.redactor_placeholder")},placeholderRemoveFromCode:function(f){return f.replace(/<span class="redactor_placeholder"(.*?)>(.*?)<\/span>/i,"")},shortcuts:function(g,f){if(!this.opts.shortcuts){return}if(!g.altKey){if(f===77){this.shortcutsLoad(g,"removeFormat")}else{if(f===66){this.shortcutsLoad(g,"bold")}else{if(f===73){this.shortcutsLoad(g,"italic")}else{if(f===74){this.shortcutsLoad(g,"insertunorderedlist")}else{if(f===75){this.shortcutsLoad(g,"insertorderedlist")}else{if(f===72){this.shortcutsLoad(g,"superscript")}else{if(f===76){this.shortcutsLoad(g,"subscript")}}}}}}}}else{if(f===48){this.shortcutsLoadFormat(g,"p")}else{if(f===49){this.shortcutsLoadFormat(g,"h1")}else{if(f===50){this.shortcutsLoadFormat(g,"h2")}else{if(f===51){this.shortcutsLoadFormat(g,"h3")}else{if(f===52){this.shortcutsLoadFormat(g,"h4")}else{if(f===53){this.shortcutsLoadFormat(g,"h5")}else{if(f===54){this.shortcutsLoadFormat(g,"h6")}}}}}}}}},shortcutsLoad:function(g,f){g.preventDefault();this.execCommand(f,false)},shortcutsLoadFormat:function(g,f){g.preventDefault();this.formatBlocks(f)},focus:function(){if(!this.browser("opera")){this.window.setTimeout(d.proxy(this.focusSet,this,true),1)}else{this.$editor.focus()}},focusEnd:function(){this.focusSet()},focusSet:function(h){this.$editor.focus();var f=this.getRange();f.selectNodeContents(this.$editor[0]);f.collapse(h||false);var g=this.getSelection();g.removeAllRanges();g.addRange(f)},toggle:function(h){var g;if(this.opts.visual){if(h!==false){this.selectionSave()}var f=null;if(this.opts.iframe){f=this.$frame.height();if(this.opts.fullpage){this.$editor.removeAttr("contenteditable")}this.$frame.hide()}else{f=this.$editor.innerHeight();this.$editor.hide()}g=this.$source.val();this.modified=g;this.$source.height(f).show().focus();this.$source.on("keydown.redactor-textarea",function(j){if(j.keyCode===9){var i=d(this);var l=i.get(0).selectionStart;i.val(i.val().substring(0,l)+"\t"+i.val().substring(i.get(0).selectionEnd));i.get(0).selectionStart=i.get(0).selectionEnd=l+1;return false}});this.buttonInactiveVisual();this.buttonActive("html");this.opts.visual=false}else{g=this.$source.hide().val();if(typeof this.modified!=="undefined"){this.modified=this.cleanRemoveSpaces(this.modified,false)!==this.cleanRemoveSpaces(g,false)}if(this.modified){if(this.opts.fullpage&&g===""){this.setFullpageOnInit(g)}else{this.set(g);if(this.opts.fullpage){this.buildBindKeyboard()}}}if(this.opts.iframe){this.$frame.show()}else{this.$editor.show()}if(this.opts.fullpage){this.$editor.attr("contenteditable",true)}this.$source.off("keydown.redactor-textarea");this.$editor.focus();this.selectionRestore();this.observeStart();this.buttonActiveVisual();this.buttonInactive("html");this.opts.visual=true}},autosave:function(){var f=false;this.autosaveInterval=setInterval(d.proxy(function(){var g=this.get();if(f!==g){d.ajax({url:this.opts.autosave,type:"post",data:this.$source.attr("name")+"="+escape(encodeURIComponent(g)),success:d.proxy(function(h){this.callback("autosave",false,h);f=g},this)})}},this),this.opts.autosaveInterval*1000)},toolbarBuild:function(){if(this.opts.air){this.opts.buttons=this.opts.airButtons}else{if(!this.opts.buttonSource){var g=this.opts.buttons.indexOf("html"),h=this.opts.buttons[g+1];this.opts.buttons.splice(g,1);if(h==="|"){this.opts.buttons.splice(g,1)}}}d.extend(this.opts.toolbar,this.opts.buttonsCustom);d.each(this.opts.buttonsAdd,d.proxy(function(j,l){this.opts.buttons.push(l)},this));if(this.opts.toolbar){d.each(this.opts.toolbar.formatting.dropdown,d.proxy(function(j,l){if(d.inArray(j,this.opts.formattingTags)=="-1"){delete this.opts.toolbar.formatting.dropdown[j]}},this))}if(this.opts.buttons.length===0){return false}this.airEnable();this.$toolbar=d("<ul>").addClass("redactor_toolbar").attr("id","redactor_toolbar_"+this.uuid);if(this.opts.air){this.$air=d('<div class="redactor_air">').attr("id","redactor_air_"+this.uuid).hide();this.$air.append(this.$toolbar);d("body").append(this.$air)}else{if(this.opts.toolbarExternal){d(this.opts.toolbarExternal).html(this.$toolbar)}else{this.$box.prepend(this.$toolbar)}}d.each(this.opts.buttons,d.proxy(function(l,m){if(m==="|"){this.$toolbar.append(d(this.opts.buttonSeparator))}else{if(this.opts.toolbar[m]){var j=this.opts.toolbar[m];if(this.opts.fileUpload===false&&m==="file"){return true}this.$toolbar.append(d("<li>").append(this.buttonBuild(m,j)))}}},this));this.$toolbar.find("a").attr("tabindex","-1");if(this.opts.toolbarFixed){this.toolbarObserveScroll();d(this.opts.toolbarFixedTarget).on("scroll.redactor",d.proxy(this.toolbarObserveScroll,this))}if(this.opts.activeButtons){var f=d.proxy(this.buttonActiveObserver,this);this.$editor.on("mouseup.redactor keyup.redactor",f)}},toolbarObserveScroll:function(){var j=d(this.opts.toolbarFixedTarget).scrollTop();var h=this.$box.offset().top;var i=0;var f=h+this.$box.height()+40;if(j>h){var g="100%";if(this.opts.toolbarFixedBox){i=this.$box.offset().left;g=this.$box.innerWidth();this.$toolbar.addClass("toolbar_fixed_box")}this.toolbarFixed=true;this.$toolbar.css({position:"fixed",width:g,zIndex:1005,top:this.opts.toolbarFixedTopOffset+"px",left:i});if(j<f){this.$toolbar.css("visibility","visible")}else{this.$toolbar.css("visibility","hidden")}}else{this.toolbarFixed=false;this.$toolbar.css({position:"relative",width:"auto",top:0,left:i});if(this.opts.toolbarFixedBox){this.$toolbar.removeClass("toolbar_fixed_box")}}},airEnable:function(){if(!this.opts.air){return}this.$editor.on("mouseup.redactor keyup.redactor",this,d.proxy(function(g){var i=this.getSelectionText();if(g.type==="mouseup"&&i!=""){this.airShow(g)}if(g.type==="keyup"&&g.shiftKey&&i!=""){var f=d(this.getElement(this.getSelection().focusNode)),h=f.offset();h.height=f.height();this.airShow(h,true)}},this))},airShow:function(j,f){if(!this.opts.air){return}var i,h;d(".redactor_air").hide();if(f){i=j.left;h=j.top+j.height+14;if(this.opts.iframe){h+=this.$box.position().top-d(this.document).scrollTop();i+=this.$box.position().left}}else{var g=this.$air.innerWidth();i=j.clientX;if(d(this.document).width()<(i+g)){i-=g}h=j.clientY+14;if(this.opts.iframe){h+=this.$box.position().top;i+=this.$box.position().left}else{h+=d(this.document).scrollTop()}}this.$air.css({left:i+"px",top:h+"px"}).show();this.airBindHide()},airBindHide:function(){if(!this.opts.air){return}var f=d.proxy(function(g){d(g).on("mousedown.redactor",d.proxy(function(h){if(d(h.target).closest(this.$toolbar).length===0){this.$air.fadeOut(100);this.selectionRemove();d(g).off(h)}},this)).on("keydown.redactor",d.proxy(function(h){if(h.which===this.keyCode.ESC){this.getSelection().collapseToStart()}this.$air.fadeOut(100);d(g).off(h)},this))},this);f(document);if(this.opts.iframe){f(this.document)}},airBindMousemoveHide:function(){if(!this.opts.air){return}var f=d.proxy(function(g){d(g).on("mousemove.redactor",d.proxy(function(h){if(d(h.target).closest(this.$toolbar).length===0){this.$air.fadeOut(100);d(g).off(h)}},this))},this);f(document);if(this.opts.iframe){f(this.document)}},pickerBuild:function(m,p){m.width(210);var o="color";if(p==="backcolor"){o="background-color"}var l=this.opts.colors.length;var n=this;for(var j=0;j<l;j++){var g=this.opts.colors[j];var h=d('<a rel="'+g+'" href="javascript:;" class="redactor_color_link"></a>').css({backgroundColor:g});m.append(h);h.on("click",function(){var i=d(this).attr("rel");if(p==="backcolor"){i=d(this).css("background-color")}n.pickerSet(o,i)})}var f=d('<a href="javascript:;" class="redactor_color_none"></a>').html(this.opts.curLang.none).on("click",function(){n.pickerSet(o,false)});m.append(f)},pickerSet:function(g,f){this.bufferSet();this.$editor.focus();this.inlineRemoveStyle(g);if(f!==false){this.inlineSetStyle(g,f)}if(this.opts.air){this.$air.fadeOut(100)}this.sync()},dropdownBuild:function(g,f){d.each(f,d.proxy(function(j,i){if(!i.className){i.className=""}var h;if(i.name==="separator"){h=d('<a class="redactor_separator_drop">')}else{h=d('<a href="javascript:;" class="'+i.className+" redactor_dropdown_"+j+'">'+i.title+"</a>");h.on("click",d.proxy(function(l){if(l.preventDefault){l.preventDefault()}if(this.browser("msie")){l.returnValue=false}if(i.callback){i.callback.call(this,j,h,i,l)}if(i.exec){this.execCommand(i.exec,j)}if(i.func){this[i.func](j)}this.buttonActiveObserver();if(this.opts.air){this.$air.fadeOut(100)}},this))}g.append(h)},this))},dropdownShow:function(m,l,i){if(!this.opts.visual){m.preventDefault();return false}if(this.buttonGet(i).hasClass("dropact")){this.dropdownHideAll()}else{this.dropdownHideAll();this.buttonActive(i);this.buttonGet(i).addClass("dropact");var h=this.buttonGet(i).position();if(this.toolbarFixed){h=this.buttonGet(i).offset()}var j=h.left+"px";var f=29;if(this.opts.air){l.css({position:"absolute",left:j,top:f+"px"}).show()}else{if(this.opts.toolbarFixed&&this.toolbarFixed){l.css({position:"fixed",left:j,top:f+"px"}).show()}else{l.css({position:"absolute",left:j,top:h.top+f+"px"}).show()}}}var g=d.proxy(function(n){this.dropdownHide(n,l)},this);d(document).one("click",g);this.$editor.one("click",g);m.stopPropagation()},dropdownHideAll:function(){this.$toolbar.find("a.dropact").removeClass("redactor_act").removeClass("dropact");d(".redactor_dropdown").hide()},dropdownHide:function(g,f){if(!d(g.target).hasClass("dropact")){f.removeClass("dropact");this.dropdownHideAll()}},buttonBuild:function(i,f){var g=d('<a href="javascript:;" title="'+f.title+'" class="redactor_btn redactor_btn_'+i+'"></a>');var h=d('<div class="redactor_dropdown" style="display: none;">');g.on("click",d.proxy(function(j){if(j.preventDefault){j.preventDefault()}if(this.browser("msie")){j.returnValue=false}if(g.hasClass("redactor_button_disabled")){return false}if(this.isFocused()===false&&!f.exec){this.$editor.focus()}if(f.exec){this.$editor.focus();this.execCommand(f.exec,i);this.airBindMousemoveHide()}else{if(f.func&&f.func!=="show"){this[f.func](i);this.airBindMousemoveHide()}else{if(f.callback){f.callback.call(this,i,g,f,j);this.airBindMousemoveHide()}else{if(i==="backcolor"||i==="fontcolor"||f.dropdown){this.dropdownShow(j,h,i)}}}}this.buttonActiveObserver(false,i)},this));if(i==="backcolor"||i==="fontcolor"||f.dropdown){h.appendTo(this.$toolbar);if(i==="backcolor"||i==="fontcolor"){this.pickerBuild(h,i)}else{this.dropdownBuild(h,f.dropdown)}}return g},buttonGet:function(f){if(!this.opts.toolbar){return false}return d(this.$toolbar.find("a.redactor_btn_"+f))},buttonActiveToggle:function(g){var f=this.buttonGet(g);if(f.hasClass("redactor_act")){f.removeClass("redactor_act")}else{f.addClass("redactor_act")}},buttonActive:function(f){this.buttonGet(f).addClass("redactor_act")},buttonInactive:function(f){this.buttonGet(f).removeClass("redactor_act")},buttonInactiveAll:function(f){d.each(this.opts.toolbar,d.proxy(function(g){if(g!=f){this.buttonInactive(g)}},this))},buttonActiveVisual:function(){this.$toolbar.find("a.redactor_btn").not("a.redactor_btn_html").removeClass("redactor_button_disabled")},buttonInactiveVisual:function(){this.$toolbar.find("a.redactor_btn").not("a.redactor_btn_html").addClass("redactor_button_disabled")},buttonChangeIcon:function(f,g){this.buttonGet(f).addClass("redactor_btn_"+g)},buttonRemoveIcon:function(f,g){this.buttonGet(f).removeClass("redactor_btn_"+g)},buttonAddSeparator:function(){this.$toolbar.append(d(this.opts.buttonSeparator))},buttonAddSeparatorAfter:function(f){this.buttonGet(f).parent().after(d(this.opts.buttonSeparator))},buttonAddSeparatorBefore:function(f){this.buttonGet(f).parent().before(d(this.opts.buttonSeparator))},buttonRemoveSeparatorAfter:function(f){this.buttonGet(f).parent().next().remove()},buttonRemoveSeparatorBefore:function(f){this.buttonGet(f).parent().prev().remove()},buttonSetRight:function(f){if(!this.opts.toolbar){return}this.buttonGet(f).parent().addClass("redactor_btn_right")},buttonSetLeft:function(f){if(!this.opts.toolbar){return}this.buttonGet(f).parent().removeClass("redactor_btn_right")},buttonAdd:function(g,h,j,i){if(!this.opts.toolbar){return}var f=this.buttonBuild(g,{title:h,callback:j,dropdown:i});this.$toolbar.append(d("<li>").append(f))},buttonAddFirst:function(g,h,j,i){if(!this.opts.toolbar){return}var f=this.buttonBuild(g,{title:h,callback:j,dropdown:i});this.$toolbar.prepend(d("<li>").append(f))},buttonAddAfter:function(m,g,i,l,j){if(!this.opts.toolbar){return}var f=this.buttonBuild(g,{title:i,callback:l,dropdown:j});var h=this.buttonGet(m);h.parent().after(d("<li>").append(f))},buttonAddBefore:function(j,g,i,m,l){if(!this.opts.toolbar){return}var f=this.buttonBuild(g,{title:i,callback:m,dropdown:l});var h=this.buttonGet(j);h.parent().before(d("<li>").append(f))},buttonRemove:function(f,h){var g=this.buttonGet(f);if(h){g.parent().next().remove()}g.parent().removeClass("redactor_btn_right");g.remove()},buttonActiveObserver:function(h,j){var f=this.getParent();this.buttonInactiveAll(j);if(h===false&&j!=="html"){if(d.inArray(j,this.opts.activeButtons)!=-1){this.buttonActiveToggle(j)}return}if(f&&f.tagName==="A"){this.$toolbar.find("a.redactor_dropdown_link").text(this.opts.curLang.link_edit)}else{this.$toolbar.find("a.redactor_dropdown_link").text(this.opts.curLang.link_insert)}if(this.opts.activeButtonsAdd){d.each(this.opts.activeButtonsAdd,d.proxy(function(l,m){this.opts.activeButtons.push(m)},this));d.extend(this.opts.activeButtonsStates,this.opts.activeButtonsAdd)}d.each(this.opts.activeButtonsStates,d.proxy(function(l,m){if(d(f).closest(l,this.$editor.get()[0]).length!=0){this.buttonActive(m)}},this));var g=d(f).closest(this.opts.alignmentTags.toString().toLowerCase(),this.$editor[0]);if(g.length){var i=g.css("text-align");switch(i){case"right":this.buttonActive("alignright");break;case"center":this.buttonActive("aligncenter");break;case"justify":this.buttonActive("justify");break;default:this.buttonActive("alignleft");break}}},exec:function(g,h,f){if(g==="formatblock"&&this.browser("msie")){h="<"+h+">"}if(g==="inserthtml"&&this.browser("msie")){this.$editor.focus();this.document.selection.createRange().pasteHTML(h)}else{this.document.execCommand(g,false,h)}if(f!==false){this.sync()}this.callback("execCommand",g,h)},execCommand:function(i,h,p){if(!this.opts.visual){this.$source.focus();return false}if(i==="inserthtml"){this.insertHtml(h,p);this.callback("execCommand",i,h);return}if(this.currentOrParentIs("PRE")&&!this.opts.formattingPre){return false}if(i==="insertunorderedlist"||i==="insertorderedlist"){this.bufferSet();var q=this.getParent();var m=d(q).closest("ol, ul");var l=false;if(m.length){l=true;var o=m[0].tagName;if((i==="insertunorderedlist"&&o==="OL")||(i==="insertorderedlist"&&o==="UL")){l=false}}this.selectionSave();if(l){var g=this.getNodes();var f=this.getBlocks(g);if(typeof g[0]!="undefined"&&g.length>1&&g[0].nodeType==3){f.unshift(this.getBlock())}var j="",r="";d.each(f,d.proxy(function(v,w){if(w.tagName=="LI"){var u=d(w);var t=u.clone();t.find("ul","ol").remove();if(this.opts.linebreaks===false){j+=this.outerHtml(d("<p>").append(t.contents()))}else{j+=t.html()+"<br>"}if(v==0){u.addClass("redactor-replaced").empty();r=this.outerHtml(u)}else{u.remove()}}},this));html=this.$editor.html().replace(r,"</"+o+">"+j+"<"+o+">");this.$editor.html(html);this.$editor.find(o+":empty").remove()}else{this.document.execCommand(i);var q=this.getParent();var m=d(q).closest("ol, ul");if(m.length){if((this.browser("msie")||this.browser("mozilla"))&&q.tagName!=="LI"){d(q).replaceWith(d(q).html())}var n=m.parent();if(this.isParentRedactor(n)&&this.nodeTestBlocks(n[0])){n.replaceWith(n.contents())}}if(this.browser("mozilla")){this.$editor.focus()}}this.selectionRestore();this.sync();this.callback("execCommand",i,h);return}if(i==="unlink"){this.bufferSet();var q=this.getParent();if(q&&d(q)[0].tagName==="A"){d(q).replaceWith(d(q).text());this.sync();this.callback("execCommand",i,h);return}}this.exec(i,h,p);if(i==="inserthorizontalrule"){this.$editor.find("hr").removeAttr("id")}},indentingIndent:function(){this.indentingStart("indent")},indentingOutdent:function(){this.indentingStart("outdent")},indentingStart:function(i){this.bufferSet();if(i==="indent"){var j=this.getBlock();this.selectionSave();if(j&&j.tagName=="LI"){var o=this.getParent();var l=d(o).closest("ol, ul");var n=l[0].tagName;var g=this.getBlocks();d.each(g,function(t,u){if(u.tagName=="LI"){var r=d(u).prev();if(r.size()!=0&&r[0].tagName=="LI"){var q=r.children("ul, ol");if(q.size()==0){r.append(d("<"+n+">").append(u))}else{q.append(u)}}}})}else{if(j===false&&this.opts.linebreaks===true){this.exec("formatBlock","blockquote");var p=this.getBlock();var j=d('<div data-tagblock="">').html(d(p).html());d(p).replaceWith(j);var h=this.normalize(d(j).css("margin-left"))+this.opts.indentValue;d(j).css("margin-left",h+"px")}else{var f=this.getBlocks();d.each(f,d.proxy(function(r,s){var q=false;if(d.inArray(s.tagName,this.opts.alignmentTags)!==-1){q=d(s)}else{q=d(s).closest(this.opts.alignmentTags.toString().toLowerCase(),this.$editor[0])}var t=this.normalize(q.css("margin-left"))+this.opts.indentValue;q.css("margin-left",t+"px")},this))}}this.selectionRestore()}else{this.selectionSave();var j=this.getBlock();if(j&&j.tagName=="LI"){var g=this.getBlocks();var m=0;this.insideOutdent(j,m,g)}else{var f=this.getBlocks();d.each(f,d.proxy(function(r,s){var q=false;if(d.inArray(s.tagName,this.opts.alignmentTags)!==-1){q=d(s)}else{q=d(s).closest(this.opts.alignmentTags.toString().toLowerCase(),this.$editor[0])}var t=this.normalize(q.css("margin-left"))-this.opts.indentValue;if(t<=0){if(this.opts.linebreaks===true&&typeof(q.data("tagblock"))!=="undefined"){q.replaceWith(q.html())}else{q.css("margin-left","");this.removeEmptyAttr(q,"style")}}else{q.css("margin-left",t+"px")}},this))}this.selectionRestore()}},insideOutdent:function(f,h,g){if(f&&f.tagName=="LI"){var i=d(f).parent().parent();if(i.size()!=0&&i[0].tagName=="LI"){i.after(f)}else{if(typeof g[h]!="undefined"){f=g[h];h++;this.insideOutdent(f,h,g)}else{this.execCommand("insertunorderedlist")}}}},cleanEmpty:function(f){var g=this.placeholderStart(f);if(g!==false){return g}if(this.opts.linebreaks===false){if(f===""){f=this.opts.emptyHtml}else{if(f.search(/^<hr\s?\/?>$/gi)!==-1){f="<hr>"+this.opts.emptyHtml}}}return f},cleanConverters:function(f){if(this.opts.convertDivs){f=f.replace(/<div(.*?)>([\w\W]*?)<\/div>/gi,"<p$1>$2</p>")}if(this.opts.paragraphy){f=this.cleanParagraphy(f)}return f},cleanConvertProtected:function(f){if(this.opts.templateVars){f=f.replace(/\{\{(.*?)\}\}/gi,"<!-- template double $1 -->");f=f.replace(/\{(.*?)\}/gi,"<!-- template $1 -->")}f=f.replace(/<script(.*?)>([\w\W]*?)<\/script>/gi,'<title type="text/javascript" style="display: none;" class="redactor-script-tag"$1>$2</title>');f=f.replace(/<style(.*?)>([\w\W]*?)<\/style>/gi,'<section$1 style="display: none;" rel="redactor-style-tag">$2</section>');f=f.replace(/<form(.*?)>([\w\W]*?)<\/form>/gi,'<section$1 rel="redactor-form-tag">$2</section>');if(this.opts.phpTags){f=f.replace(/<\?php([\w\W]*?)\?>/gi,'<section style="display: none;" rel="redactor-php-tag">$1</section>')}else{f=f.replace(/<\?php([\w\W]*?)\?>/gi,"")}return f},cleanReConvertProtected:function(f){if(this.opts.templateVars){f=f.replace(/<!-- template double (.*?) -->/gi,"{{$1}}");f=f.replace(/<!-- template (.*?) -->/gi,"{$1}")}f=f.replace(/<title type="text\/javascript" style="display: none;" class="redactor-script-tag"(.*?)>([\w\W]*?)<\/title>/gi,'<script$1 type="text/javascript">$2<\/script>');f=f.replace(/<section(.*?) style="display: none;" rel="redactor-style-tag">([\w\W]*?)<\/section>/gi,"<style$1>$2</style>");f=f.replace(/<section(.*?)rel="redactor-form-tag"(.*?)>([\w\W]*?)<\/section>/gi,"<form$1$2>$3</form>");if(this.opts.phpTags){f=f.replace(/<section style="display: none;" rel="redactor-php-tag">([\w\W]*?)<\/section>/gi,"<?php\r\n$1\r\n?>")}return f},cleanRemoveSpaces:function(g,f){if(f!==false){var f=[];var i=g.match(/<(pre|style|script|title)(.*?)>([\w\W]*?)<\/(pre|style|script|title)>/gi);if(this.opts.phpTags){var h=g.match(/<\?php([\w\W]*?)\?>/gi);if(h){i=d.merge(i,h)}}if(i){d.each(i,function(j,l){g=g.replace(l,"buffer_"+j);f.push(l)})}}g=g.replace(/\n/g," ");g=g.replace(/[\t]*/g,"");g=g.replace(/\n\s*\n/g,"\n");g=g.replace(/^[\s\n]*/g," ");g=g.replace(/[\s\n]*$/g," ");g=g.replace(/>\s{2,}</g,"><");g=this.cleanReplacer(g,f);g=g.replace(/\n\n/g,"\n");return g},cleanReplacer:function(g,f){if(f===false){return g}d.each(f,function(h,j){g=g.replace("buffer_"+h,j)});return g},cleanRemoveEmptyTags:function(j){j=j.replace(/<span>([\w\W]*?)<\/span>/gi,"$1");j=j.replace(/[\u200B-\u200D\uFEFF]/g,"");var l=["<b>\\s*</b>","<b>&nbsp;</b>","<em>\\s*</em>"];var h=["<pre></pre>","<blockquote>\\s*</blockquote>","<dd></dd>","<dt></dt>","<ul></ul>","<ol></ol>","<li></li>","<table></table>","<tr></tr>","<span>\\s*<span>","<span>&nbsp;<span>","<p>\\s*</p>","<p></p>","<p>&nbsp;</p>","<p>\\s*<br>\\s*</p>","<div>\\s*</div>","<div>\\s*<br>\\s*</div>"];if(this.opts.removeEmptyTags){h=h.concat(l)}else{h=l}var f=h.length;for(var g=0;g<f;++g){j=j.replace(new RegExp(h[g],"gi"),"")}return j},cleanParagraphy:function(m){m=d.trim(m);if(this.opts.linebreaks===true){return m}if(m===""||m==="<p></p>"){return this.opts.emptyHtml}m=m+"\n";var o=[];var l=m.match(/<(table|div|pre|object)(.*?)>([\w\W]*?)<\/(table|div|pre|object)>/gi);var n=m.match(/<!--([\w\W]*?)-->/gi);if(n){l=d.merge(l,n)}if(this.opts.phpTags){var g=m.match(/<section(.*?)rel="redactor-php-tag">([\w\W]*?)<\/section>/gi);if(g){l=d.merge(l,g)}}if(l){d.each(l,function(q,r){o[q]=r;m=m.replace(r,"{replace"+q+"}\n")})}m=m.replace(/<br \/>\s*<br \/>/gi,"\n\n");function j(s,i,q){return m.replace(new RegExp(s,i),q)}var f="(comment|html|body|head|title|meta|style|script|link|iframe|table|thead|tfoot|caption|col|colgroup|tbody|tr|td|th|div|dl|dd|dt|ul|ol|li|pre|select|option|form|map|area|blockquote|address|math|style|p|h[1-6]|hr|fieldset|legend|section|article|aside|hgroup|header|footer|nav|figure|figcaption|details|menu|summary)";m=j("(<"+f+"[^>]*>)","gi","\n$1");m=j("(</"+f+">)","gi","$1\n\n");m=j("\r\n","g","\n");m=j("\r","g","\n");m=j("/\n\n+/","g","\n\n");var p=m.split(new RegExp("\ns*\n","g"),-1);m="";for(var h in p){if(p.hasOwnProperty(h)){if(p[h].search("{replace")==-1){m+="<p>"+p[h].replace(/^\n+|\n+$/g,"")+"</p>"}else{m+=p[h]}}}if(m.search(/<blockquote/gi)!==-1){d.each(m.match(/<blockquote(.*?)>([\w\W]*?)<\/blockquote>/gi),function(q,r){var t="";t=r.replace("<p>","");t=t.replace("</p>","<br>");m=m.replace(r,t)})}m=j("<p>s*</p>","gi","");m=j("<p>([^<]+)</(div|address|form)>","gi","<p>$1</p></$2>");m=j("<p>s*(</?"+f+"[^>]*>)s*</p>","gi","$1");m=j("<p>(<li.+?)</p>","gi","$1");m=j("<p>s*(</?"+f+"[^>]*>)","gi","$1");m=j("(</?"+f+"[^>]*>)s*</p>","gi","$1");m=j("(</?"+f+"[^>]*>)s*<br />","gi","$1");m=j("<br />(s*</?(?:p|li|div|dl|dd|dt|th|pre|td|ul|ol)[^>]*>)","gi","$1");m=j("\n</p>","gi","</p>");m=j("</li><p>","gi","</li>");m=j("<p>\t?\n?<p>","gi","<p>");m=j("</dt><p>","gi","</dt>");m=j("</dd><p>","gi","</dd>");m=j("<br></p></blockquote>","gi","</blockquote>");m=j("<p>    </p>","gi","");d.each(o,function(q,r){m=m.replace("{replace"+q+"}",r)});return d.trim(m)},cleanConvertInlineTags:function(f){var g="strong";if(this.opts.boldTag==="b"){g="b"}var h="em";if(this.opts.italicTag==="i"){h="i"}f=f.replace(/<span style="font-style: italic;">([\w\W]*?)<\/span>/gi,"<"+h+">$1</"+h+">");f=f.replace(/<span style="font-weight: bold;">([\w\W]*?)<\/span>/gi,"<"+g+">$1</"+g+">");if(this.opts.boldTag==="strong"){f=f.replace(/<b>([\w\W]*?)<\/b>/gi,"<strong>$1</strong>")}else{f=f.replace(/<strong>([\w\W]*?)<\/strong>/gi,"<b>$1</b>")}if(this.opts.italicTag==="em"){f=f.replace(/<i>([\w\W]*?)<\/i>/gi,"<em>$1</em>")}else{f=f.replace(/<em>([\w\W]*?)<\/em>/gi,"<i>$1</i>")}f=f.replace(/<strike>([\w\W]*?)<\/strike>/gi,"<del>$1</del>");if(!/<span(.*?)data-redactor="verified"(.*?)>([\w\W]*?)<\/span>/gi.test(f)){f=f.replace(/<span(.*?)(?!data-redactor="verified")(.*?)>([\w\W]*?)<\/span>/gi,'<span$1 data-redactor="verified"$2>$3</span>')}return f},cleanStripTags:function(h){if(h==""||typeof h=="undefined"){return h}var i=false;if(this.opts.allowedTags!==false){i=true}var f=i===true?this.opts.allowedTags:this.opts.deniedTags;var g=/<\/?([a-z][a-z0-9]*)\b[^>]*>/gi;h=h.replace(g,function(l,j){if(i===true){return d.inArray(j.toLowerCase(),f)>"-1"?l:""}else{return d.inArray(j.toLowerCase(),f)>"-1"?"":l}});h=this.cleanConvertInlineTags(h);return h},cleanSavePreCode:function(f,g){var h=f.match(/<(pre|code)(.*?)>([\w\W]*?)<\/(pre|code)>/gi);if(h!==null){d.each(h,d.proxy(function(l,m){var j=m.match(/<(pre|code)(.*?)>([\w\W]*?)<\/(pre|code)>/i);j[3]=j[3].replace(/&nbsp;/g," ");if(g!==false){j[3]=this.cleanEncodeEntities(j[3])}f=f.replace(m,"<"+j[1]+j[2]+">"+j[3]+"</"+j[1]+">")},this))}return f},cleanEncodeEntities:function(f){f=String(f).replace(/&amp;/g,"&").replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&quot;/g,'"');return String(f).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")},cleanUnverified:function(){var f=this.$editor.find("li, img, a, b, strong, sub, sup, i, em, u, small, strike, del, span, cite");f.not('[data-redactor="verified"]').filter('[style*="font-size"][style*="line-height"]').css("font-size","").css("line-height","");f.not('[data-redactor="verified"]').filter('[style*="background-color: transparent;"][style*="line-height"]').css("background-color","").css("line-height","");f.not('[data-redactor="verified"]').filter('[style*="background-color: transparent;"]').css("background-color","");f.not('[data-redactor="verified"]').css("line-height","");d.each(f,d.proxy(function(g,h){this.removeEmptyAttr(h,"style")},this));this.$editor.find('div[style="text-align: -webkit-auto;"]').contents().unwrap()},cleanHtml:function(g){var l=0,n=g.length,m=0,f=null,h=null,q="",j="",p="";this.cleanlevel=0;for(;l<n;l++){m=l;if(-1==g.substr(l).indexOf("<")){j+=g.substr(l);return this.cleanFinish(j)}while(m<n&&g.charAt(m)!="<"){m++}if(l!=m){p=g.substr(l,m-l);if(!p.match(/^\s{2,}$/g)){if("\n"==j.charAt(j.length-1)){j+=this.cleanGetTabs()}else{if("\n"==p.charAt(0)){j+="\n"+this.cleanGetTabs();p=p.replace(/^\s+/,"")}}j+=p}if(p.match(/\n/)){j+="\n"+this.cleanGetTabs()}}f=m;while(m<n&&">"!=g.charAt(m)){m++}q=g.substr(f,m-f);l=m;var o;if("!--"==q.substr(1,3)){if(!q.match(/--$/)){while("-->"!=g.substr(m,3)){m++}m+=2;q=g.substr(f,m-f);l=m}if("\n"!=j.charAt(j.length-1)){j+="\n"}j+=this.cleanGetTabs();j+=q+">\n"}else{if("!"==q[1]){j=this.placeTag(q+">",j)}else{if("?"==q[1]){j+=q+">\n"}else{if(o=q.match(/^<(script|style|pre)/i)){o[1]=o[1].toLowerCase();q=this.cleanTag(q);j=this.placeTag(q,j);h=String(g.substr(l+1)).toLowerCase().indexOf("</"+o[1]);if(h){p=g.substr(l+1,h);l+=h;j+=p}}else{q=this.cleanTag(q);j=this.placeTag(q,j)}}}}}return this.cleanFinish(j)},cleanGetTabs:function(){var g="";for(var f=0;f<this.cleanlevel;f++){g+="\t"}return g},cleanFinish:function(f){f=f.replace(/\n\s*\n/g,"\n");f=f.replace(/^[\s\n]*/,"");f=f.replace(/[\s\n]*$/,"");f=f.replace(/<script(.*?)>\n<\/script>/gi,"<script$1><\/script>");this.cleanlevel=0;return f},cleanTag:function(g){var i="";g=g.replace(/\n/g," ");g=g.replace(/\s{2,}/g," ");g=g.replace(/^\s+|\s+$/g," ");var h="";if(g.match(/\/$/)){h="/";g=g.replace(/\/+$/,"")}var f;while(f=/\s*([^= ]+)(?:=((['"']).*?\3|[^ ]+))?/.exec(g)){if(f[2]){i+=f[1].toLowerCase()+"="+f[2]}else{if(f[1]){i+=f[1].toLowerCase()}}i+=" ";g=g.substr(f[0].length)}return i.replace(/\s*$/,"")+h+">"},placeTag:function(f,h){var g=f.match(this.cleannewLevel);if(f.match(this.cleanlineBefore)||g){h=h.replace(/\s*$/,"");h+="\n"}if(g&&"/"==f.charAt(1)){this.cleanlevel--}if("\n"==h.charAt(h.length-1)){h+=this.cleanGetTabs()}if(g&&"/"!=f.charAt(1)){this.cleanlevel++}h+=f;if(f.match(this.cleanlineAfter)||f.match(this.cleannewLevel)){h=h.replace(/ *$/,"");h+="\n"}return h},alignmentLeft:function(){this.alignmentSet("","JustifyLeft")},alignmentRight:function(){this.alignmentSet("right","JustifyRight")},alignmentCenter:function(){this.alignmentSet("center","JustifyCenter")},alignmentJustify:function(){this.alignmentSet("justify","JustifyFull")},alignmentSet:function(g,i){this.bufferSet();if(this.oldIE()){this.document.execCommand(i,false,false);return true}this.selectionSave();var j=this.getBlock();if(!j&&this.opts.linebreaks){this.exec("formatBlock","blockquote");var f=this.getBlock();var j=d('<div data-tagblock="">').html(d(f).html());d(f).replaceWith(j);d(j).css("text-align",g);this.removeEmptyAttr(j,"style");if(g==""&&typeof(d(j).data("tagblock"))!=="undefined"){d(j).replaceWith(d(j).html())}}else{var h=this.getBlocks();d.each(h,d.proxy(function(m,n){var l=false;if(d.inArray(n.tagName,this.opts.alignmentTags)!==-1){l=d(n)}else{l=d(n).closest(this.opts.alignmentTags.toString().toLowerCase(),this.$editor[0])}if(l){l.css("text-align",g);this.removeEmptyAttr(l,"style")}},this))}this.selectionRestore();this.sync()},formatEmpty:function(i){var f=d.trim(this.$editor.html());f=f.replace(/<br\s?\/?>/i,"");var h=f.replace(/<p>\s?<\/p>/gi,"");if(f===""||h===""){i.preventDefault();var g=d(this.opts.emptyHtml).get(0);this.$editor.html(g);this.focus()}this.sync()},formatBlocks:function(f){this.bufferSet();var g=this.getBlocks();this.selectionSave();d.each(g,d.proxy(function(h,j){if(j.tagName!=="LI"){this.formatBlock(f,j)}},this));this.selectionRestore();this.sync()},formatBlock:function(f,i){if(i===false){i=this.getBlock()}if(i===false){if(this.opts.linebreaks===true){this.execCommand("formatblock",f)}return true}var h="";if(f!=="pre"){h=d(i).contents()}else{h=d(i).html();if(d.trim(h)===""){h='<span id="selection-marker-1"></span>'}}if(i.tagName==="PRE"){f="p"}if(this.opts.linebreaks===true&&f==="p"){d(i).replaceWith(d("<div>").append(h).html()+"<br>")}else{var g=d("<"+f+">").append(h);d(i).replaceWith(g)}},formatChangeTag:function(h,f,g){if(g!==false){this.selectionSave()}var i=d("<"+f+"/>");d(h).replaceWith(function(){return i.append(d(this).contents())});if(g!==false){this.selectionRestore()}return i},formatQuote:function(){this.bufferSet();if(this.opts.linebreaks===false){this.selectionSave();var l=this.getBlocks();if(l){d.each(l,d.proxy(function(n,o){if(o.tagName==="BLOCKQUOTE"){this.formatBlock("p",o,false)}else{if(o.tagName!=="LI"){this.formatBlock("blockquote",o,false)}}},this))}this.selectionRestore()}else{var j=this.getBlock();if(j.tagName==="BLOCKQUOTE"){this.selectionSave();d(j).replaceWith(d(j).html()+"<br>");this.selectionRestore()}else{var m=this.selectionWrap("blockquote");var h=d(m).html();var g=["ul","ol","table","tr","tbody","thead","tfoot","dl"];d.each(g,function(n,o){h=h.replace(new RegExp("<"+o+"(.*?)>","gi"),"");h=h.replace(new RegExp("</"+o+">","gi"),"")});var f=this.opts.blockLevelElements;f.push("td");d.each(f,function(n,o){h=h.replace(new RegExp("<"+o+"(.*?)>","gi"),"");h=h.replace(new RegExp("</"+o+">","gi"),"<br>")});d(m).html(h);this.selectionElement(m);var i=d(m).next();if(i.size()!=0&&i[0].tagName==="BR"){i.remove()}}}this.sync()},blockRemoveAttr:function(f,h){var g=this.getBlocks();d(g).removeAttr(f);this.sync()},blockSetAttr:function(f,h){var g=this.getBlocks();d(g).attr(f,h);this.sync()},blockRemoveStyle:function(g){var f=this.getBlocks();d(f).css(g,"");this.removeEmptyAttr(f,"style");this.sync()},blockSetStyle:function(h,g){var f=this.getBlocks();d(f).css(h,g);this.sync()},blockRemoveClass:function(g){var f=this.getBlocks();d(f).removeClass(g);this.removeEmptyAttr(f,"class");this.sync()},blockSetClass:function(g){var f=this.getBlocks();d(f).addClass(g);this.sync()},inlineRemoveClass:function(f){this.selectionSave();this.inlineEachNodes(function(g){d(g).removeClass(f);this.removeEmptyAttr(g,"class")});this.selectionRestore();this.sync()},inlineSetClass:function(f){var g=this.getCurrent();if(!d(g).hasClass(f)){this.inlineMethods("addClass",f)}},inlineRemoveStyle:function(f){this.selectionSave();this.inlineEachNodes(function(g){d(g).css(f,"");this.removeEmptyAttr(g,"style")});this.selectionRestore();this.sync()},inlineSetStyle:function(g,f){this.inlineMethods("css",g,f)},inlineRemoveAttr:function(f){this.selectionSave();var h=this.getRange(),i=this.getElement(),g=this.getNodes();if(h.collapsed||h.startContainer===h.endContainer&&i){g=d(i)}d(g).removeAttr(f);this.inlineUnwrapSpan();this.selectionRestore();this.sync()},inlineSetAttr:function(f,g){this.inlineMethods("attr",f,g)},inlineMethods:function(i,f,j){this.bufferSet();this.selectionSave();var g=this.getRange();var h=this.getElement();if(g.collapsed||g.startContainer===g.endContainer&&h){d(h)[i](f,j)}else{this.document.execCommand("fontSize",false,4);var l=this.$editor.find("font");d.each(l,d.proxy(function(m,n){this.inlineSetMethods(i,n,f,j)},this))}this.selectionRestore();this.sync()},inlineSetMethods:function(j,i,f,l){var h=d(i).parent(),g;if(h&&h[0].tagName==="SPAN"&&h[0].attributes.length!=0){g=h;d(i).replaceWith(d(i).html())}else{g=d('<span data-redactor="verified" data-redactor-inlineMethods>').append(d(i).contents());d(i).replaceWith(g)}d(g)[j](f,l);return g},inlineEachNodes:function(j){var g=this.getRange(),h=this.getElement(),f=this.getNodes(),i;if(g.collapsed||g.startContainer===g.endContainer&&h){f=d(h);i=true}d.each(f,d.proxy(function(l,m){if(!i&&m.tagName!=="SPAN"){if(m.parentNode.tagName==="SPAN"&&!d(m.parentNode).hasClass("redactor_editor")){m=m.parentNode}else{return}}j.call(this,m)},this))},inlineUnwrapSpan:function(){var f=this.$editor.find("span[data-redactor-inlineMethods]");d.each(f,d.proxy(function(h,j){var g=d(j);if(g.attr("class")===undefined&&g.attr("style")===undefined){g.contents().unwrap()}},this))},inlineFormat:function(f){this.selectionSave();this.document.execCommand("fontSize",false,4);var h=this.$editor.find("font");var g;d.each(h,function(j,m){var l=d("<"+f+"/>").append(d(m).contents());d(m).replaceWith(l);g=l});this.selectionRestore();this.sync()},inlineRemoveFormat:function(f){this.selectionSave();var g=f.toUpperCase();var h=this.getNodes();d.each(h,function(j,l){if(l.tagName===g){d(l).replaceWith(d(l).contents())}});this.selectionRestore();this.sync()},insertHtml:function(h,j){var m=this.getCurrent();var i=m.parentNode;this.$editor.focus();this.bufferSet();var f=d("<div>").append(d.parseHTML(h));h=f.html();h=this.cleanRemoveEmptyTags(h);f=d("<div>").append(d.parseHTML(h));var g=this.getBlock();if(f.contents().length==1){var l=f.contents()[0].tagName;if(l!="P"&&l==g.tagName||l=="PRE"){h=f.text();f=d("<div>").append(h)}}if(!this.opts.linebreaks&&f.contents().length==1&&f.contents()[0].nodeType==3&&(this.getRangeSelectedNodes().length>2||(!m||m.tagName=="BODY"&&!i||i.tagName=="HTML"))){h="<p>"+h+"</p>"}if(f.contents().length>1&&g||f.contents().is("p, :header, ul, ol, div, table, blockquote, pre, address, section, header, footer, aside, article")){if(this.browser("msie")){this.document.selection.createRange().pasteHTML(h)}else{this.document.execCommand("inserthtml",false,h)}}else{this.insertHtmlAdvanced(h)}if(this.selectall){this.window.setTimeout(d.proxy(function(){if(!this.opts.linebreaks){this.selectionEnd(this.$editor.contents().last())}else{this.focusEnd()}},this),1)}this.observeStart();if(j!==false){this.sync()}},insertHtmlAdvanced:function(g){var l=this.getSelection();if(l.getRangeAt&&l.rangeCount){var f=l.getRangeAt(0);f.deleteContents();var h=this.document.createElement("div");h.innerHTML=g;var m=this.document.createDocumentFragment(),j,i;while((j=h.firstChild)){i=m.appendChild(j)}f.insertNode(m);if(i){f=f.cloneRange();f.setStartAfter(i);f.collapse(true);l.removeAllRanges();l.addRange(f)}}},insertText:function(g){var f=d(d.parseHTML(g));if(f.length){g=f.text()}this.$editor.focus();if(this.browser("msie")){this.document.selection.createRange().pasteHTML(g)}else{this.document.execCommand("inserthtml",false,g)}this.sync()},insertNode:function(f){f=f[0]||f;var g=this.getSelection();if(g.getRangeAt&&g.rangeCount){range=g.getRangeAt(0);range.deleteContents();range.insertNode(f);range.setEndAfter(f);range.setStartAfter(f);g.removeAllRanges();g.addRange(range)}},insertNodeToCaretPositionFromPoint:function(j,i){var g;var f=j.clientX,m=j.clientY;if(this.document.caretPositionFromPoint){var l=this.document.caretPositionFromPoint(f,m);g=this.getRange();g.setStart(l.offsetNode,l.offset);g.collapse(true);g.insertNode(i)}else{if(this.document.caretRangeFromPoint){g=this.document.caretRangeFromPoint(f,m);g.insertNode(i)}else{if(typeof document.body.createTextRange!="undefined"){g=this.document.body.createTextRange();g.moveToPoint(f,m);var h=g.duplicate();h.moveToPoint(f,m);g.setEndPoint("EndToEnd",h);g.select()}}}},insertAfterLastElement:function(f){if(this.isEndOfElement()){if(d(d.trim(this.$editor.html())).get(0)!=d.trim(f)&&this.$editor.contents().last()[0]!==f){return false}this.bufferSet();if(this.opts.linebreaks===false){var g=d(this.opts.emptyHtml);d(f).after(g);this.selectionStart(g)}else{var g=d('<span id="selection-marker-1">'+this.opts.invisibleSpace+"</span>",this.document)[0];d(f).after(g);d(g).after(this.opts.invisibleSpace);this.selectionRestore()}}},insertLineBreak:function(){this.selectionSave();this.$editor.find("#selection-marker-1").before("<br>"+(this.browser("webkit")?this.opts.invisibleSpace:""));this.selectionRestore()},insertDoubleLineBreak:function(){this.selectionSave();this.$editor.find("#selection-marker-1").before("<br><br>"+(this.browser("webkit")?this.opts.invisibleSpace:""));this.selectionRestore()},replaceLineBreak:function(f){var g=d("<br>"+this.opts.invisibleSpace);d(f).replaceWith(g);this.selectionStart(g)},pasteClean:function(h){h=this.callback("pasteBefore",false,h);if(this.opts.pastePlainText){var g=this.document.createElement("div");h=h.replace(/<br>|<\/H[1-6]>|<\/p>|<\/div>/gi,"\n");g.innerHTML=h;h=g.textContent||g.innerText;h=h.replace("\n","<br>");h=this.cleanParagraphy(h);this.pasteInsert(h)}if(this.currentOrParentIs("PRE")){h=this.pastePre(h);this.pasteInsert(h);return true}h=h.replace(/<p(.*?)class="MsoListParagraphCxSpFirst"([\w\W]*?)<\/p>/gi,"<ul><p$2</p>");h=h.replace(/<p(.*?)class="MsoListParagraphCxSpLast"([\w\W]*?)<\/p>/gi,"<p$2</p></ul>");h=h.replace(/<!--[\s\S]*?-->|<\?(?:php)?[\s\S]*?\?>/gi,"");h=h.replace(/(&nbsp;){2,}/gi,"&nbsp;");h=h.replace(/&nbsp;/gi," ");h=h.replace(/<b\sid="internal-source-marker(.*?)">([\w\W]*?)<\/b>/gi,"$2");h=h.replace(/<b(.*?)id="docs-internal-guid(.*?)">([\w\W]*?)<\/b>/gi,"$3");h=this.cleanStripTags(h);h=h.replace(/<td><\/td>/gi,"[td]");h=h.replace(/<td>&nbsp;<\/td>/gi,"[td]");h=h.replace(/<td><br><\/td>/gi,"[td]");h=h.replace(/<a(.*?)href="(.*?)"(.*?)>([\w\W]*?)<\/a>/gi,'[a href="$2"]$4[/a]');h=h.replace(/<iframe(.*?)>([\w\W]*?)<\/iframe>/gi,"[iframe$1]$2[/iframe]");h=h.replace(/<video(.*?)>([\w\W]*?)<\/video>/gi,"[video$1]$2[/video]");h=h.replace(/<audio(.*?)>([\w\W]*?)<\/audio>/gi,"[audio$1]$2[/audio]");h=h.replace(/<embed(.*?)>([\w\W]*?)<\/embed>/gi,"[embed$1]$2[/embed]");h=h.replace(/<object(.*?)>([\w\W]*?)<\/object>/gi,"[object$1]$2[/object]");h=h.replace(/<param(.*?)>/gi,"[param$1]");h=h.replace(/<img(.*?)style="(.*?)"(.*?)>/gi,"[img$1$3]");h=h.replace(/<img(.*?)>/gi,"[img$1]");h=h.replace(/ class="(.*?)"/gi,"");h=h.replace(/<(\w+)([\w\W]*?)>/gi,"<$1>");h=h.replace(/<[^\/>][^>]*>(\s*|\t*|\n*|&nbsp;|<br>)<\/[^>]+>/gi,"");h=h.replace(/<div>\s*?\t*?\n*?(<ul>|<ol>|<p>)/gi,"$1");h=h.replace(/\[td\]/gi,"<td>&nbsp;</td>");h=h.replace(/\[a href="(.*?)"\]([\w\W]*?)\[\/a\]/gi,'<a href="$1">$2</a>');h=h.replace(/\[iframe(.*?)\]([\w\W]*?)\[\/iframe\]/gi,"<iframe$1>$2</iframe>");h=h.replace(/\[video(.*?)\]([\w\W]*?)\[\/video\]/gi,"<video$1>$2</video>");h=h.replace(/\[audio(.*?)\]([\w\W]*?)\[\/audio\]/gi,"<audio$1>$2</audio>");h=h.replace(/\[embed(.*?)\]([\w\W]*?)\[\/embed\]/gi,"<embed$1>$2</embed>");h=h.replace(/\[object(.*?)\]([\w\W]*?)\[\/object\]/gi,"<object$1>$2</object>");h=h.replace(/\[param(.*?)\]/gi,"<param$1>");h=h.replace(/\[img(.*?)\]/gi,"<img$1>");if(this.opts.convertDivs){h=h.replace(/<div(.*?)>([\w\W]*?)<\/div>/gi,"<p>$2</p>");h=h.replace(/<\/div><p>/gi,"<p>");h=h.replace(/<\/p><\/div>/gi,"</p>")}h=this.cleanParagraphy(h);h=h.replace(/<span(.*?)>([\w\W]*?)<\/span>/gi,"$2");h=h.replace(/<img>/gi,"");h=h.replace(/<[^\/>][^>][^img|param|source]*>(\s*|\t*|\n*|&nbsp;|<br>)<\/[^>]+>/gi,"");h=h.replace(/\n{3,}/gi,"\n");h=h.replace(/<p><p>/gi,"<p>");h=h.replace(/<\/p><\/p>/gi,"</p>");h=h.replace(/<li>(\s*|\t*|\n*)<p>/gi,"<li>");h=h.replace(/<\/p>(\s*|\t*|\n*)<\/li>/gi,"</li>");if(this.opts.linebreaks===true){h=h.replace(/<p(.*?)>([\w\W]*?)<\/p>/gi,"$2<br>")}h=h.replace(/<[^\/>][^>][^img|param|source]*>(\s*|\t*|\n*|&nbsp;|<br>)<\/[^>]+>/gi,"");h=h.replace(/<img src="webkit-fake-url\:\/\/(.*?)"(.*?)>/gi,"");this.pasteClipboardMozilla=false;if(this.browser("mozilla")){if(this.opts.clipboardUpload){var i=h.match(/<img src="data:image(.*?)"(.*?)>/gi);if(i!==null){this.pasteClipboardMozilla=i;for(k in i){var f=i[k].replace("<img",'<img data-mozilla-paste-image="'+k+'" ');h=h.replace(i[k],f)}}}while(/<br>$/gi.test(h)){h=h.replace(/<br>$/gi,"")}}h=h.replace(/<p>([\w\W]*?)<\/p>/gi,"<li>$1</li>");while(/<font>([\w\W]*?)<\/font>/gi.test(h)){h=h.replace(/<font>([\w\W]*?)<\/font>/gi,"$1")}this.pasteInsert(h)},pastePre:function(g){g=g.replace(/<br>|<\/H[1-6]>|<\/p>|<\/div>/gi,"\n");var f=this.document.createElement("div");f.innerHTML=g;return this.cleanEncodeEntities(f.textContent||f.innerText)},pasteInsert:function(f){if(this.selectall){if(!this.opts.linebreaks){this.$editor.html(this.opts.emptyHtml)}else{this.$editor.html("")}this.$editor.focus()}f=this.callback("pasteAfter",false,f);this.insertHtml(f);this.selectall=false;setTimeout(d.proxy(function(){a=false;if(this.pasteClipboardMozilla!==false){this.pasteClipboardUploadMozilla()}},this),100);if(this.opts.autoresize){d(this.document.body).scrollTop(this.saveScroll)}else{this.$editor.scrollTop(this.saveScroll)}},pasteClipboardUploadMozilla:function(){var f=this.$editor.find("img[data-mozilla-paste-image]");d.each(f,d.proxy(function(j,l){var h=d(l);var g=l.src.split(",");var m=g[1];var n=g[0].split(";")[0].split(":")[1];d.post(this.opts.clipboardUploadUrl,{contentType:n,data:m},d.proxy(function(o){var i=d.parseJSON(o);h.attr("src",i.filelink);h.removeAttr("data-mozilla-paste-image");this.sync();this.callback("imageUpload",h,i)},this))},this))},pasteClipboardUpload:function(i){var g=i.target.result;var f=g.split(",");var h=f[1];var j=f[0].split(";")[0].split(":")[1];if(this.opts.clipboardUpload){d.post(this.opts.clipboardUploadUrl,{contentType:j,data:h},d.proxy(function(n){var m=d.parseJSON(n);var l='<img src="'+m.filelink+'" id="clipboard-image-marker" />';this.execCommand("inserthtml",l,false);var o=d(this.$editor.find("img#clipboard-image-marker"));if(o.length){o.removeAttr("id")}else{o=false}this.sync();if(o){this.callback("imageUpload",o,m)}},this))}else{this.insertHtml('<img src="'+g+'" />')}},bufferSet:function(f){if(f!==undefined){this.opts.buffer.push(f)}else{this.selectionSave();this.opts.buffer.push(this.$editor.html());this.selectionRemoveMarkers("buffer")}},bufferUndo:function(){if(this.opts.buffer.length===0){this.$editor.focus();return}this.selectionSave();this.opts.rebuffer.push(this.$editor.html());this.selectionRestore(false,true);this.$editor.html(this.opts.buffer.pop());this.selectionRestore();setTimeout(d.proxy(this.observeStart,this),100)},bufferRedo:function(){if(this.opts.rebuffer.length===0){this.$editor.focus();return false}this.selectionSave();this.opts.buffer.push(this.$editor.html());this.selectionRestore(false,true);this.$editor.html(this.opts.rebuffer.pop());this.selectionRestore(true);setTimeout(d.proxy(this.observeStart,this),4)},observeStart:function(){this.observeImages();this.observeTables()},observeTables:function(){this.$editor.find("table").on("click",d.proxy(this.tableObserver,this))},observeImages:function(){if(this.opts.observeImages===false){return false}this.$editor.find("img").each(d.proxy(function(f,g){if(this.browser("msie")){d(g).attr("unselectable","on")}this.imageResize(g)},this))},getSelection:function(){if(!this.opts.rangy){return this.document.getSelection()}else{if(!this.opts.iframe){return rangy.getSelection()}else{return rangy.getSelection(this.$frame[0])}}},getRange:function(){if(!this.opts.rangy){if(this.document.getSelection){var f=this.document.getSelection();if(f.getRangeAt&&f.rangeCount){return f.getRangeAt(0)}}return this.document.createRange()}else{if(!this.opts.iframe){return rangy.createRange()}else{return rangy.createRange(this.iframeDoc())}}},selectionElement:function(f){this.setCaret(f)},selectionStart:function(f){this.selectionSet(f[0]||f,0,null,0)},selectionEnd:function(f){this.selectionSet(f[0]||f,1,null,1)},selectionSet:function(m,l,j,h){if(j==null){j=m}if(h==null){h=l}var g=this.getSelection();if(!g){return}var f=this.getRange();f.setStart(m,l);f.setEnd(j,h);try{g.removeAllRanges()}catch(i){}g.addRange(f)},selectionWrap:function(f){f=f.toLowerCase();var i=this.getBlock();if(i){var j=this.formatChangeTag(i,f);this.sync();return j}var h=this.getSelection();var g=h.getRangeAt(0);var j=document.createElement(f);j.appendChild(g.extractContents());g.insertNode(j);this.selectionElement(j);return j},selectionAll:function(){var f=this.getRange();f.selectNodeContents(this.$editor[0]);var g=this.getSelection();g.removeAllRanges();g.addRange(f)},selectionRemove:function(){this.getSelection().removeAllRanges()},getCaretOffset:function(i){var f=0;var h=this.getRange();var g=h.cloneRange();g.selectNodeContents(i);g.setEnd(h.endContainer,h.endOffset);f=d.trim(g.toString()).length;return f},getCaretOffsetRange:function(){return new e(this.getSelection().getRangeAt(0))},setCaret:function(j,g,n){if(typeof n==="undefined"){n=g}j=j[0]||j;var p=this.getRange();p.selectNodeContents(j);var q=this.getTextNodesIn(j);var m=false;var f=0,r;if(q.length==1&&g){p.setStart(q[0],g);p.setEnd(q[0],n)}else{for(var o=0,l;l=q[o++];){r=f+l.length;if(!m&&g>=f&&(g<r||(g==r&&o<q.length))){p.setStart(l,g-f);m=true}if(m&&n<=r){p.setEnd(l,n-f);break}f=r}}var h=this.getSelection();h.removeAllRanges();h.addRange(p)},getTextNodesIn:function(l){var j=[];if(l.nodeType==3){j.push(l)}else{var h=l.childNodes;for(var g=0,f=h.length;g<f;++g){j.push.apply(j,this.getTextNodesIn(h[g]))}}return j},selectionSave:function(){if(!this.isFocused()){this.$editor.focus()}if(!this.opts.rangy){this.selectionCreateMarker(this.getRange())}else{this.savedSel=rangy.saveSelection()}},selectionCreateMarker:function(i,f){if(!i){return}var h=d('<span id="selection-marker-1" class="redactor-selection-marker">'+this.opts.invisibleSpace+"</span>",this.document)[0];var g=d('<span id="selection-marker-2" class="redactor-selection-marker">'+this.opts.invisibleSpace+"</span>",this.document)[0];if(i.collapsed===true){this.selectionSetMarker(i,h,true)}else{this.selectionSetMarker(i,h,true);this.selectionSetMarker(i,g,false)}this.savedSel=this.$editor.html();this.selectionRestore(false,false)},selectionSetMarker:function(f,h,g){var i=f.cloneRange();i.collapse(g);i.insertNode(h);i.detach()},selectionRestore:function(i,f){if(!this.opts.rangy){if(i===true&&this.savedSel){this.$editor.html(this.savedSel)}var h=this.$editor.find("span#selection-marker-1");var g=this.$editor.find("span#selection-marker-2");if(this.browser("mozilla")){this.$editor.focus()}else{if(!this.isFocused()){this.$editor.focus()}}if(h.length!=0&&g.length!=0){this.selectionSet(h[0],0,g[0],0)}else{if(h.length!=0){this.selectionSet(h[0],0,null,0)}}if(f!==false){this.selectionRemoveMarkers();this.savedSel=false}}else{rangy.restoreSelection(this.savedSel)}},selectionRemoveMarkers:function(f){if(!this.opts.rangy){d.each(this.$editor.find("span.redactor-selection-marker"),function(){var g=d.trim(d(this).html().replace(/[^\u0000-~]/g,""));if(g==""){d(this).remove()}else{d(this).removeAttr("class").removeAttr("id")}})}else{rangy.removeMarkers(this.savedSel)}},getCurrent:function(){var f=false;var g=this.getSelection();if(g.rangeCount>0){f=g.getRangeAt(0).startContainer}return this.isParentRedactor(f)},getParent:function(f){f=f||this.getCurrent();if(f){return this.isParentRedactor(d(f).parent()[0])}else{return false}},getBlock:function(f){if(typeof f==="undefined"){f=this.getCurrent()}while(f){if(this.nodeTestBlocks(f)){if(d(f).hasClass("redactor_editor")){return false}return f}f=f.parentNode}return false},getBlocks:function(g){var h=[];if(typeof g=="undefined"){var f=this.getRange();if(f&&f.collapsed===true){return[this.getBlock()]}var g=this.getNodes(f)}d.each(g,d.proxy(function(j,l){if(this.opts.iframe===false&&d(l).parents("div.redactor_editor").size()==0){return false}if(this.nodeTestBlocks(l)){h.push(l)}},this));if(h.length===0){h=[this.getBlock()]}return h},nodeTestBlocks:function(f){return f.nodeType==1&&this.rTestBlock.test(f.nodeName)},tagTestBlock:function(f){return this.rTestBlock.test(f)},getSelectedNodes:function(j){if(typeof j=="undefined"||j==false){var j=this.getRange()}if(j&&j.collapsed===true){return[this.getCurrent()]}var f=this.getSelection();try{var p=f.getRangeAt(0).cloneContents()}catch(n){return(false)}var l=this.document.createElement("span");l.appendChild(p);window.selnodes=l.childNodes;var m=selnodes.length;var g=[];for(var h=0,o=m;h<o;h++){g.push(selnodes[h])}if(g.length==0){g.push(this.getCurrent())}return g},getNodes:function(h,f){if(this.opts.linebreaks){return this.getSelectedNodes(h)}if(typeof h=="undefined"||h==false){var h=this.getRange()}if(h&&h.collapsed===true){if(typeof f==="undefined"&&this.tagTestBlock(f)){var l=this.getBlock();if(l.tagName==f){return[l]}else{return[]}}else{return[this.getCurrent()]}}var g=[],j=[];var i=this.document.getSelection();if(!i.isCollapsed){g=this.getRangeSelectedNodes(i.getRangeAt(0))}d.each(g,d.proxy(function(m,n){if(this.opts.iframe===false&&d(n).parents("div.redactor_editor").size()==0){return false}if(typeof f==="undefined"){if(d.trim(n.textContent)!=""){j.push(n)}}else{if(n.tagName==f){j.push(n)}}},this));if(j.length==0){if(typeof f==="undefined"&&this.tagTestBlock(f)){var l=this.getBlock();if(l.tagName==f){return j.push(l)}else{return[]}}else{j.push(this.getCurrent())}}return j},getElement:function(f){if(!f){f=this.getCurrent()}while(f){if(f.nodeType==1){if(d(f).hasClass("redactor_editor")){return false}return f}f=f.parentNode}return false},getRangeSelectedNodes:function(g){g=g||this.getRange();var h=g.startContainer;var f=g.endContainer;if(h==f){return[h]}var i=[];while(h&&h!=f){i.push(h=this.nextNode(h))}h=g.startContainer;while(h&&h!=g.commonAncestorContainer){i.unshift(h);h=h.parentNode}return i},nextNode:function(f){if(f.hasChildNodes()){return f.firstChild}else{while(f&&!f.nextSibling){f=f.parentNode}if(!f){return null}return f.nextSibling}},getSelectionText:function(){return this.getSelection().toString()},getSelectionHtml:function(){var j="";var l=this.getSelection();if(l.rangeCount){var g=this.document.createElement("div");var f=l.rangeCount;for(var h=0;h<f;++h){g.appendChild(l.getRangeAt(h).cloneContents())}j=g.innerHTML}return this.syncClean(j)},tableShow:function(){this.selectionSave();this.modalInit(this.opts.curLang.table,this.opts.modal_table,300,d.proxy(function(){d("#redactor_insert_table_btn").click(d.proxy(this.tableInsert,this));setTimeout(function(){d("#redactor_table_rows").focus()},200)},this))},tableInsert:function(){var s=d("#redactor_table_rows").val(),g=d("#redactor_table_columns").val(),o=d("<div></div>"),f=Math.floor(Math.random()*99999),q=d('<table id="table'+f+'"><tbody></tbody></table>'),h,m,n,p;for(h=0;h<s;h++){m=d("<tr></tr>");for(n=0;n<g;n++){p=d("<td>"+this.opts.invisibleSpace+"</td>");if(h===0&&n===0){p.append('<span id="selection-marker-1">'+this.opts.invisibleSpace+"</span>")}d(m).append(p)}q.append(m)}o.append(q);var j=o.html();this.modalClose();this.selectionRestore();var l=this.getBlock()||this.getCurrent();if(l){d(l).after(j)}else{this.insertHtmlAdvanced(j)}this.selectionRestore();var r=this.$editor.find("#table"+f);this.tableObserver(r);this.buttonActiveObserver();r.removeAttr("id");this.sync()},tableObserver:function(f){this.$table=d(f.target||f).closest("table");this.$tbody=d(f.target).closest("tbody");this.$thead=this.$table.find("thead");this.$current_td=d(f.target||this.$table.find("td").first());this.$current_tr=d(f.target||this.$table.find("tr").first()).closest("tr")},tableDeleteTable:function(){this.bufferSet();if(!this.$table){return}this.$table.remove();this.$table=false;this.sync()},tableDeleteRow:function(){this.bufferSet();if(!this.$current_tr){return}var f=this.$current_tr.prev().length?this.$current_tr.prev():this.$current_tr.next();if(f.length){var g=f.children("td").first();if(g.length){g.prepend('<span id="selection-marker-1">'+this.opts.invisibleSpace+"</span>");this.selectionRestore()}}this.$current_tr.remove();this.sync()},tableDeleteColumn:function(){this.bufferSet();var f=this.$current_td.get(0).cellIndex;this.$table.find("tr").each(d.proxy(function(g,h){var j=f-1<0?f+1:f-1;if(g===0){d(h).find("td").eq(j).prepend('<span id="selection-marker-1">'+this.opts.invisibleSpace+"</span>");this.selectionRestore()}d(h).find("td").eq(f).remove()},this));this.sync()},tableAddHead:function(){this.bufferSet();if(this.$table.find("thead").size()!==0){this.tableDeleteHead()}else{var f=this.$table.find("tr").first().clone();f.find("td").html(this.opts.invisibleSpace);this.$thead=d("<thead></thead>");this.$thead.append(f);this.$table.prepend(this.$thead);this.sync()}},tableDeleteHead:function(){this.bufferSet();d(this.$thead).remove();this.$thead=false;this.sync()},tableAddRowAbove:function(){this.tableAddRow("before")},tableAddRowBelow:function(){this.tableAddRow("after")},tableAddColumnLeft:function(){this.tableAddColumn("before")},tableAddColumnRight:function(){this.tableAddColumn("after")},tableAddRow:function(f){this.bufferSet();var g=this.$current_tr.clone();g.find("td").html(this.opts.invisibleSpace);if(f==="after"){this.$current_tr.after(g)}else{this.$current_tr.before(g)}this.sync()},tableAddColumn:function(g){this.bufferSet();var f=0;this.$current_tr.find("td").each(d.proxy(function(h,j){if(d(j)[0]===this.$current_td[0]){f=h}},this));this.$table.find("tr").each(d.proxy(function(h,l){var j=d(l).find("td").eq(f);var m=j.clone();m.html(this.opts.invisibleSpace);g==="after"?j.after(m):j.before(m)},this));this.sync()},videoShow:function(){this.selectionSave();this.modalInit(this.opts.curLang.video,this.opts.modal_video,600,d.proxy(function(){d("#redactor_insert_video_btn").click(d.proxy(this.videoInsert,this));setTimeout(function(){d("#redactor_insert_video_area").focus()},200)},this))},videoInsert:function(){var f=d("#redactor_insert_video_area").val();f=this.cleanStripTags(f);this.selectionRestore();var g=this.getBlock()||this.getCurrent();if(g){d(g).after(f)}else{this.insertHtmlAdvanced(f)}this.sync();this.modalClose()},linkShow:function(){this.selectionSave();var f=d.proxy(function(){this.insert_link_node=false;var h=this.getSelection();var g="",o="",j="";var i=this.getParent();var l=d(i).parent().get(0);if(l&&l.tagName==="A"){i=l}if(i&&i.tagName==="A"){g=i.href;o=d(i).text();j=i.target;this.insert_link_node=i}else{o=h.toString()}d(".redactor_link_text").val(o);var q=self.location.href.replace(/\/$/i,"");var n=g.replace(q,"");if(this.opts.linkProtocol===false){var p=new RegExp("^(http|ftp|https)://"+self.location.host,"i");n=n.replace(p,"")}var m=d("#redactor_tabs").find("a");if(this.opts.linkEmail===false){m.eq(1).remove()}if(this.opts.linkAnchor===false){m.eq(2).remove()}if(this.opts.linkEmail===false&&this.opts.linkAnchor===false){d("#redactor_tabs").remove();d("#redactor_link_url").val(n)}else{if(g.search("mailto:")===0){this.modalSetTab.call(this,2);d("#redactor_tab_selected").val(2);d("#redactor_link_mailto").val(g.replace("mailto:",""))}else{if(n.search(/^#/gi)===0){this.modalSetTab.call(this,3);d("#redactor_tab_selected").val(3);d("#redactor_link_anchor").val(n.replace(/^#/gi,""))}else{d("#redactor_link_url").val(n)}}}if(j==="_blank"){d("#redactor_link_blank").prop("checked",true)}d("#redactor_insert_link_btn").click(d.proxy(this.linkProcess,this));setTimeout(function(){d("#redactor_link_url").focus()},200)},this);this.modalInit(this.opts.curLang.link,this.opts.modal_link,460,f)},linkProcess:function(){var j=d("#redactor_tab_selected").val();var h="",n="",l="",m="";if(j==="1"){h=d("#redactor_link_url").val();n=d("#redactor_link_url_text").val();if(d("#redactor_link_blank").prop("checked")){l=' target="_blank"';m="_blank"}var i="((xn--)?[a-z0-9]+(-[a-z0-9]+)*.)+[a-z]{2,}";var g=new RegExp("^(http|ftp|https)://"+i,"i");var f=new RegExp("^"+i,"i");if(h.search(g)==-1&&h.search(f)==0&&this.opts.linkProtocol){h=this.opts.linkProtocol+h}}else{if(j==="2"){h="mailto:"+d("#redactor_link_mailto").val();n=d("#redactor_link_mailto_text").val()}else{if(j==="3"){h="#"+d("#redactor_link_anchor").val();n=d("#redactor_link_anchor_text").val()}}}this.linkInsert('<a href="'+h+'"'+l+">"+n+"</a>",d.trim(n),h,m)},linkInsert:function(f,i,g,h){this.selectionRestore();if(i!==""){if(this.insert_link_node){this.bufferSet();d(this.insert_link_node).text(i).attr("href",g);if(h!==""){d(this.insert_link_node).attr("target",h)}else{d(this.insert_link_node).removeAttr("target")}this.sync()}else{this.exec("inserthtml",f)}}this.modalClose()},fileShow:function(){this.selectionSave();var f=d.proxy(function(){var g=this.getSelection();var h="";if(this.oldIE()){h=g.text}else{h=g.toString()}d("#redactor_filename").val(h);if(!this.isMobile()){this.draguploadInit("#redactor_file",{url:this.opts.fileUpload,uploadFields:this.opts.uploadFields,success:d.proxy(this.fileCallback,this),error:d.proxy(function(j,i){this.callback("fileUploadError",i)},this)})}this.uploadInit("redactor_file",{auto:true,url:this.opts.fileUpload,success:d.proxy(this.fileCallback,this),error:d.proxy(function(j,i){this.callback("fileUploadError",i)},this)})},this);this.modalInit(this.opts.curLang.file,this.opts.modal_file,500,f)},fileCallback:function(g){this.selectionRestore();if(g!==false){var i=d("#redactor_filename").val();if(i===""){i=g.filename}var h='<a href="'+g.filelink+'" id="filelink-marker">'+i+"</a>";if(this.browser("webkit")&&!!this.window.chrome){h=h+"&nbsp;"}this.execCommand("inserthtml",h,false);var f=d(this.$editor.find("a#filelink-marker"));if(f.size()!=0){f.removeAttr("id")}else{f=false}this.sync();this.callback("fileUpload",f,g)}this.modalClose()},imageShow:function(){this.selectionSave();var f=d.proxy(function(){if(this.opts.imageGetJson){d.getJSON(this.opts.imageGetJson,d.proxy(function(m){var i={},l=0;d.each(m,d.proxy(function(o,p){if(typeof p.folder!=="undefined"){l++;i[p.folder]=l}},this));var j=false;d.each(m,d.proxy(function(r,s){var q="";if(typeof s.title!=="undefined"){q=s.title}var o=0;if(!d.isEmptyObject(i)&&typeof s.folder!=="undefined"){o=i[s.folder];if(j===false){j=".redactorfolder"+o}}var p=d('<img src="'+s.thumb+'" class="redactorfolder redactorfolder'+o+'" rel="'+s.image+'" title="'+q+'" />');d("#redactor_image_box").append(p);d(p).click(d.proxy(this.imageThumbClick,this))},this));if(!d.isEmptyObject(i)){d(".redactorfolder").hide();d(j).show();var n=function(o){d(".redactorfolder").hide();d(".redactorfolder"+d(o.target).val()).show()};var h=d('<select id="redactor_image_box_select">');d.each(i,function(p,o){h.append(d('<option value="'+o+'">'+p+"</option>"))});d("#redactor_image_box").before(h);h.change(n)}},this))}else{d("#redactor_tabs").find("a").eq(1).remove()}if(this.opts.imageUpload||this.opts.s3){if(!this.isMobile()&&this.opts.s3===false){if(d("#redactor_file").length){this.draguploadInit("#redactor_file",{url:this.opts.imageUpload,uploadFields:this.opts.uploadFields,success:d.proxy(this.imageCallback,this),error:d.proxy(function(i,h){this.callback("imageUploadError",h)},this)})}}if(this.opts.s3===false){this.uploadInit("redactor_file",{auto:true,url:this.opts.imageUpload,success:d.proxy(this.imageCallback,this),error:d.proxy(function(i,h){this.callback("imageUploadError",h)},this)})}else{d("#redactor_file").on("change.redactor",d.proxy(this.s3handleFileSelect,this))}}else{d(".redactor_tab").hide();if(!this.opts.imageGetJson){d("#redactor_tabs").remove();d("#redactor_tab3").show()}else{var g=d("#redactor_tabs").find("a");g.eq(0).remove();g.eq(1).addClass("redactor_tabs_act");d("#redactor_tab2").show()}}d("#redactor_upload_btn").click(d.proxy(this.imageCallbackLink,this));if(!this.opts.imageUpload&&!this.opts.imageGetJson){setTimeout(function(){d("#redactor_file_link").focus()},200)}},this);this.modalInit(this.opts.curLang.image,this.opts.modal_image,610,f)},imageEdit:function(h){var f=h;var g=f.parent().parent();var i=d.proxy(function(){d("#redactor_file_alt").val(f.attr("alt"));d("#redactor_image_edit_src").attr("href",f.attr("src"));d("#redactor_form_image_align").val(f.css("float"));if(d(g).get(0).tagName==="A"){d("#redactor_file_link").val(d(g).attr("href"));if(d(g).attr("target")=="_blank"){d("#redactor_link_blank").prop("checked",true)}}d("#redactor_image_delete_btn").click(d.proxy(function(){this.imageRemove(f)},this));d("#redactorSaveBtn").click(d.proxy(function(){this.imageSave(f)},this))},this);this.modalInit(this.opts.curLang.image,this.opts.modal_image_edit,380,i)},imageRemove:function(g){var f=d(g).parent();d(g).remove();if(f.length&&f[0].tagName==="P"){this.$editor.focus();this.selectionStart(f)}this.callback("imageDelete",g);this.modalClose();this.sync()},imageSave:function(i){var g=d(i);var h=g.parent();g.attr("alt",d("#redactor_file_alt").val());var n=d("#redactor_form_image_align").val();if(n==="left"){g.css({"float":"left",margin:"0 10px 10px 0"})}else{if(n==="right"){g.css({"float":"right",margin:"0 0 10px 10px"})}else{var l=g.closest("#redactor-image-box");if(l.size()!=0){l.css({"float":"",margin:""})}g.css({"float":"",margin:""})}}var j=d.trim(d("#redactor_file_link").val());if(j!==""){var m=false;if(d("#redactor_link_blank").prop("checked")){m=true}if(h.get(0).tagName!=="A"){var f=d('<a href="'+j+'">'+this.outerHtml(i)+"</a>");if(m){f.attr("target","_blank")}g.replaceWith(f)}else{h.attr("href",j);if(m){h.attr("target","_blank")}else{h.removeAttr("target")}}}else{if(h.get(0).tagName==="A"){h.replaceWith(this.outerHtml(i))}}this.modalClose();this.observeImages();this.sync()},imageResizeHide:function(h){if(h!==false&&d(h.target).parent().size()!=0&&d(h.target).parent()[0].id==="redactor-image-box"){return false}var f=this.$editor.find("#redactor-image-box");if(f.size()==0){return false}this.$editor.find("#redactor-image-editter, #redactor-image-resizer").remove();var g=f.css("margin");if(g!="0px"){f.find("img").css("margin",g);f.css("margin","")}f.find("img").css("opacity",1);f.replaceWith(function(){return d(this).contents()});d(document).off("click.redactor-image-resize-hide");this.$editor.off("click.redactor-image-resize-hide");this.$editor.off("keydown.redactor-image-delete")},imageResize:function(g){var f=d(g);f.on("mousedown",d.proxy(function(){this.imageResizeHide(false)},this));f.on("dragstart",d.proxy(function(){this.$editor.on("drop.redactor-image-inside-drop",d.proxy(function(){setTimeout(d.proxy(function(){this.observeImages();this.$editor.off("drop.redactor-image-inside-drop");this.sync()},this),1)},this))},this));f.on("click",d.proxy(function(l){if(this.$editor.find("#redactor-image-box").size()!=0){return false}var n=false,q,p,m=f.width()/f.height(),o=20,j=10;var h=this.imageResizeControls(f);var i=false;h.on("mousedown",function(r){i=true;r.preventDefault();m=f.width()/f.height();q=Math.round(r.pageX-f.eq(0).offset().left);p=Math.round(r.pageY-f.eq(0).offset().top)});d(this.document.body).on("mousemove",d.proxy(function(v){if(i){var s=Math.round(v.pageX-f.eq(0).offset().left)-q;var r=Math.round(v.pageY-f.eq(0).offset().top)-p;var u=f.height();var w=parseInt(u,10)+r;var t=Math.round(w*m);if(t>o){f.width(t);if(t<100){this.imageEditter.css({marginTop:"-7px",marginLeft:"-13px",fontSize:"9px",padding:"3px 5px"})}else{this.imageEditter.css({marginTop:"-11px",marginLeft:"-18px",fontSize:"11px",padding:"7px 10px"})}}q=Math.round(v.pageX-f.eq(0).offset().left);p=Math.round(v.pageY-f.eq(0).offset().top);this.sync()}},this)).on("mouseup",function(){i=false});this.$editor.on("keydown.redactor-image-delete",d.proxy(function(s){var r=s.which;if(this.keyCode.BACKSPACE==r||this.keyCode.DELETE==r){this.imageResizeHide(false);this.imageRemove(f)}},this));d(document).on("click.redactor-image-resize-hide",d.proxy(this.imageResizeHide,this));this.$editor.on("click.redactor-image-resize-hide",d.proxy(this.imageResizeHide,this))},this))},imageResizeControls:function(g){var h=d('<span id="redactor-image-box" data-redactor="verified">');h.css({position:"relative",display:"inline-block",lineHeight:0,outline:"1px dashed rgba(0, 0, 0, .6)","float":g.css("float")});h.attr("contenteditable",false);var i=g.css("margin");if(i!="0px"){h.css("margin",i);g.css("margin","")}g.css("opacity",0.5).after(h);this.imageEditter=d('<span id="redactor-image-editter" data-redactor="verified">'+this.opts.curLang.edit+"</span>");this.imageEditter.css({position:"absolute",zIndex:2,top:"50%",left:"50%",marginTop:"-11px",marginLeft:"-18px",lineHeight:1,backgroundColor:"#000",color:"#fff",fontSize:"11px",padding:"7px 10px",cursor:"pointer"});this.imageEditter.attr("contenteditable",false);this.imageEditter.on("click",d.proxy(function(){this.imageEdit(g)},this));h.append(this.imageEditter);var f=d('<span id="redactor-image-resizer" data-redactor="verified"></span>');f.css({position:"absolute",zIndex:2,lineHeight:1,cursor:"nw-resize",bottom:"-4px",right:"-5px",border:"1px solid #fff",backgroundColor:"#000",width:"8px",height:"8px"});f.attr("contenteditable",false);h.append(f);h.append(g);return f},imageThumbClick:function(g){var f='<img id="image-marker" src="'+d(g.target).attr("rel")+'" alt="'+d(g.target).attr("title")+'" />';if(this.opts.paragraphy){f="<p>"+f+"</p>"}this.imageInsert(f,true)},imageCallbackLink:function(){var g=d("#redactor_file_link").val();if(g!==""){var f='<img id="image-marker" src="'+g+'" />';if(this.opts.linebreaks===false){f="<p>"+f+"</p>"}this.imageInsert(f,true)}else{this.modalClose()}},imageCallback:function(f){this.imageInsert(f)},imageInsert:function(g,h){this.selectionRestore();if(g!==false){var f="";if(h!==true){f='<img id="image-marker" src="'+g.filelink+'" />';if(this.opts.paragraphy){f="<p>"+f+"</p>"}}else{f=g}this.execCommand("inserthtml",f,false);var i=d(this.$editor.find("img#image-marker"));if(i.length){i.removeAttr("id")}else{i=false}this.sync();h!==true&&this.callback("imageUpload",i,g)}this.modalClose();this.observeImages()},modalTemplatesInit:function(){d.extend(this.opts,{modal_file:String()+'<section><div id="redactor-progress" class="redactor-progress redactor-progress-striped" style="display: none;"><div id="redactor-progress-bar" class="redactor-progress-bar" style="width: 100%;"></div></div><form id="redactorUploadFileForm" method="post" action="" enctype="multipart/form-data"><label>'+this.opts.curLang.filename+'</label><input type="text" id="redactor_filename" class="redactor_input" /><div style="margin-top: 7px;"><input type="file" id="redactor_file" name="file" /></div></form></section>',modal_image_edit:String()+"<section><label>"+this.opts.curLang.title+'</label><input id="redactor_file_alt" class="redactor_input" /><label>'+this.opts.curLang.link+'</label><input id="redactor_file_link" class="redactor_input" /><label><input type="checkbox" id="redactor_link_blank"> '+this.opts.curLang.link_new_tab+"</label><label>"+this.opts.curLang.image_position+'</label><select id="redactor_form_image_align"><option value="none">'+this.opts.curLang.none+'</option><option value="left">'+this.opts.curLang.left+'</option><option value="right">'+this.opts.curLang.right+'</option></select></section><footer><button id="redactor_image_delete_btn" class="redactor_modal_btn">'+this.opts.curLang._delete+'</button>&nbsp;&nbsp;&nbsp;<button class="redactor_modal_btn redactor_btn_modal_close">'+this.opts.curLang.cancel+'</button><input type="button" name="save" class="redactor_modal_btn" id="redactorSaveBtn" value="'+this.opts.curLang.save+'" /></footer>',modal_image:String()+'<section><div id="redactor_tabs"><a href="#" class="redactor_tabs_act">'+this.opts.curLang.upload+'</a><a href="#">'+this.opts.curLang.choose+'</a><a href="#">'+this.opts.curLang.link+'</a></div><div id="redactor-progress" class="redactor-progress redactor-progress-striped" style="display: none;"><div id="redactor-progress-bar" class="redactor-progress-bar" style="width: 100%;"></div></div><form id="redactorInsertImageForm" method="post" action="" enctype="multipart/form-data"><div id="redactor_tab1" class="redactor_tab"><input type="file" id="redactor_file" name="file" /></div><div id="redactor_tab2" class="redactor_tab" style="display: none;"><div id="redactor_image_box"></div></div></form><div id="redactor_tab3" class="redactor_tab" style="display: none;"><label>'+this.opts.curLang.image_web_link+'</label><input type="text" name="redactor_file_link" id="redactor_file_link" class="redactor_input"  /></div></section><footer><button class="redactor_modal_btn redactor_btn_modal_close">'+this.opts.curLang.cancel+'</button><input type="button" name="upload" class="redactor_modal_btn" id="redactor_upload_btn" value="'+this.opts.curLang.insert+'" /></footer>',modal_link:String()+'<section><form id="redactorInsertLinkForm" method="post" action=""><div id="redactor_tabs"><a href="#" class="redactor_tabs_act">URL</a><a href="#">Email</a><a href="#">'+this.opts.curLang.anchor+'</a></div><input type="hidden" id="redactor_tab_selected" value="1" /><div class="redactor_tab" id="redactor_tab1"><label>URL</label><input type="text" id="redactor_link_url" class="redactor_input"  /><label>'+this.opts.curLang.text+'</label><input type="text" class="redactor_input redactor_link_text" id="redactor_link_url_text" /><label><input type="checkbox" id="redactor_link_blank"> '+this.opts.curLang.link_new_tab+'</label></div><div class="redactor_tab" id="redactor_tab2" style="display: none;"><label>Email</label><input type="text" id="redactor_link_mailto" class="redactor_input" /><label>'+this.opts.curLang.text+'</label><input type="text" class="redactor_input redactor_link_text" id="redactor_link_mailto_text" /></div><div class="redactor_tab" id="redactor_tab3" style="display: none;"><label>'+this.opts.curLang.anchor+'</label><input type="text" class="redactor_input" id="redactor_link_anchor"  /><label>'+this.opts.curLang.text+'</label><input type="text" class="redactor_input redactor_link_text" id="redactor_link_anchor_text" /></div></form></section><footer><button class="redactor_modal_btn redactor_btn_modal_close">'+this.opts.curLang.cancel+'</button><input type="button" class="redactor_modal_btn" id="redactor_insert_link_btn" value="'+this.opts.curLang.insert+'" /></footer>',modal_table:String()+"<section><label>"+this.opts.curLang.rows+'</label><input type="text" size="5" value="2" id="redactor_table_rows" /><label>'+this.opts.curLang.columns+'</label><input type="text" size="5" value="3" id="redactor_table_columns" /></section><footer><button class="redactor_modal_btn redactor_btn_modal_close">'+this.opts.curLang.cancel+'</button><input type="button" name="upload" class="redactor_modal_btn" id="redactor_insert_table_btn" value="'+this.opts.curLang.insert+'" /></footer>',modal_video:String()+'<section><form id="redactorInsertVideoForm"><label>'+this.opts.curLang.video_html_code+'</label><textarea id="redactor_insert_video_area" style="width: 99%; height: 160px;"></textarea></form></section><footer><button class="redactor_modal_btn redactor_btn_modal_close">'+this.opts.curLang.cancel+'</button><input type="button" class="redactor_modal_btn" id="redactor_insert_video_btn" value="'+this.opts.curLang.insert+'" /></footer>'})},modalInit:function(m,i,g,n){var f=d("#redactor_modal_overlay");if(!f.length){this.$overlay=f=d('<div id="redactor_modal_overlay" style="display: none;"></div>');d("body").prepend(this.$overlay)}if(this.opts.modalOverlay){f.show().on("click",d.proxy(this.modalClose,this))}var j=d("#redactor_modal");if(!j.length){this.$modal=j=d('<div id="redactor_modal" style="display: none;"><div id="redactor_modal_close">&times;</div><header id="redactor_modal_header"></header><div id="redactor_modal_inner"></div></div>');d("body").append(this.$modal)}d("#redactor_modal_close").on("click",d.proxy(this.modalClose,this));this.hdlModalClose=d.proxy(function(o){if(o.keyCode===this.keyCode.ESC){this.modalClose();return false}},this);d(document).keyup(this.hdlModalClose);this.$editor.keyup(this.hdlModalClose);this.modalcontent=false;if(i.indexOf("#")==0){this.modalcontent=d(i);d("#redactor_modal_inner").empty().append(this.modalcontent.html());this.modalcontent.html("")}else{d("#redactor_modal_inner").empty().append(i)}j.find("#redactor_modal_header").html(m);if(typeof d.fn.draggable!=="undefined"){j.draggable({handle:"#redactor_modal_header"});j.find("#redactor_modal_header").css("cursor","move")}var l=d("#redactor_tabs");if(l.length){var h=this;l.find("a").each(function(o,p){o++;d(p).on("click",function(r){r.preventDefault();l.find("a").removeClass("redactor_tabs_act");d(this).addClass("redactor_tabs_act");d(".redactor_tab").hide();d("#redactor_tab"+o).show();d("#redactor_tab_selected").val(o);if(h.isMobile()===false){var q=j.outerHeight();j.css("margin-top","-"+(q+10)/2+"px")}})})}j.find(".redactor_btn_modal_close").on("click",d.proxy(this.modalClose,this));if(this.opts.autoresize===true){this.saveModalScroll=this.document.body.scrollTop}if(this.isMobile()===false){j.css({position:"fixed",top:"-2000px",left:"50%",width:g+"px",marginLeft:"-"+(g+60)/2+"px"}).show();this.modalSaveBodyOveflow=d(document.body).css("overflow");d(document.body).css("overflow","hidden")}else{j.css({position:"fixed",width:"100%",height:"100%",top:"0",left:"0",margin:"0",minHeight:"300px"}).show()}if(typeof n==="function"){n()}if(this.isMobile()===false){setTimeout(function(){var o=j.outerHeight();j.css({top:"50%",height:"auto",minHeight:"auto",marginTop:"-"+(o+10)/2+"px"})},10)}},modalClose:function(){d("#redactor_modal_close").off("click",this.modalClose);d("#redactor_modal").fadeOut("fast",d.proxy(function(){var f=d("#redactor_modal_inner");if(this.modalcontent!==false){this.modalcontent.html(f.html());this.modalcontent=false}f.html("");if(this.opts.modalOverlay){d("#redactor_modal_overlay").hide().off("click",this.modalClose)}d(document).unbind("keyup",this.hdlModalClose);this.$editor.unbind("keyup",this.hdlModalClose);this.selectionRestore();if(this.opts.autoresize&&this.saveModalScroll){d(this.document.body).scrollTop(this.saveModalScroll)}},this));if(this.isMobile()===false){d(document.body).css("overflow",this.modalSaveBodyOveflow?this.modalSaveBodyOveflow:"visible")}return false},modalSetTab:function(f){d(".redactor_tab").hide();d("#redactor_tabs").find("a").removeClass("redactor_tabs_act").eq(f-1).addClass("redactor_tabs_act");d("#redactor_tab"+f).show()},s3handleFileSelect:function(l){var h=l.target.files;for(var g=0,j;j=h[g];g++){this.s3uploadFile(j)}},s3uploadFile:function(f){this.s3executeOnSignedUrl(f,d.proxy(function(g){this.s3uploadToS3(f,g)},this))},s3executeOnSignedUrl:function(f,h){var g=new XMLHttpRequest();g.open("GET",this.opts.s3+"?name="+f.name+"&type="+f.type,true);g.overrideMimeType("text/plain; charset=x-user-defined");g.onreadystatechange=function(i){if(this.readyState==4&&this.status==200){d("#redactor-progress").fadeIn();h(decodeURIComponent(this.responseText))}else{if(this.readyState==4&&this.status!=200){}}};g.send()},s3createCORSRequest:function(h,f){var g=new XMLHttpRequest();if("withCredentials" in g){g.open(h,f,true)}else{if(typeof XDomainRequest!="undefined"){g=new XDomainRequest();g.open(h,f)}else{g=null}}return g},s3uploadToS3:function(g,f){var h=this.s3createCORSRequest("PUT",f);if(!h){}else{h.onload=d.proxy(function(){if(h.status==200){d("#redactor-progress").hide();var l=f.split("?");if(!l[0]){return false}this.selectionRestore();var i="";i='<img id="image-marker" src="'+l[0]+'" />';if(this.opts.paragraphy){i="<p>"+i+"</p>"}this.execCommand("inserthtml",i,false);var j=d(this.$editor.find("img#image-marker"));if(j.length){j.removeAttr("id")}else{j=false}this.sync();this.callback("imageUpload",j,false);this.modalClose();this.observeImages()}else{}},this);h.onerror=function(){};h.upload.onprogress=function(i){};h.setRequestHeader("Content-Type",g.type);h.setRequestHeader("x-amz-acl","public-read");h.send(g)}},uploadInit:function(h,f){this.uploadOptions={url:false,success:false,error:false,start:false,trigger:false,auto:false,input:false};d.extend(this.uploadOptions,f);var g=d("#"+h);if(g.length&&g[0].tagName==="INPUT"){this.uploadOptions.input=g;this.el=d(g[0].form)}else{this.el=g}this.element_action=this.el.attr("action");if(this.uploadOptions.auto){d(this.uploadOptions.input).change(d.proxy(function(i){this.el.submit(function(j){return false});this.uploadSubmit(i)},this))}else{if(this.uploadOptions.trigger){d("#"+this.uploadOptions.trigger).click(d.proxy(this.uploadSubmit,this))}}},uploadSubmit:function(f){d("#redactor-progress").fadeIn();this.uploadForm(this.element,this.uploadFrame())},uploadFrame:function(){this.id="f"+Math.floor(Math.random()*99999);var g=this.document.createElement("div");var f='<iframe style="display:none" id="'+this.id+'" name="'+this.id+'"></iframe>';g.innerHTML=f;d(g).appendTo("body");if(this.uploadOptions.start){this.uploadOptions.start()}d("#"+this.id).load(d.proxy(this.uploadLoaded,this));return this.id},uploadForm:function(j,i){if(this.uploadOptions.input){var l="redactorUploadForm"+this.id,g="redactorUploadFile"+this.id;this.form=d('<form  action="'+this.uploadOptions.url+'" method="POST" target="'+i+'" name="'+l+'" id="'+l+'" enctype="multipart/form-data" />');if(this.opts.uploadFields!==false&&typeof this.opts.uploadFields==="object"){d.each(this.opts.uploadFields,d.proxy(function(n,f){if(f!=null&&f.toString().indexOf("#")===0){f=d(f).val()}var o=d("<input/>",{type:"hidden",name:n,value:f});d(this.form).append(o)},this))}var h=this.uploadOptions.input;var m=d(h).clone();d(h).attr("id",g).before(m).appendTo(this.form);d(this.form).css("position","absolute").css("top","-2000px").css("left","-2000px").appendTo("body");this.form.submit()}else{j.attr("target",i).attr("method","POST").attr("enctype","multipart/form-data").attr("action",this.uploadOptions.url);this.element.submit()}},uploadLoaded:function(){var j=d("#"+this.id)[0],l;if(j.contentDocument){l=j.contentDocument}else{if(j.contentWindow){l=j.contentWindow.document}else{l=window.frames[this.id].document}}if(this.uploadOptions.success){d("#redactor-progress").hide();if(typeof l!=="undefined"){var h=l.body.innerHTML;var g=h.match(/\{(.|\n)*\}/)[0];g=g.replace(/^\[/,"");g=g.replace(/\]$/,"");var f=d.parseJSON(g);if(typeof f.error=="undefined"){this.uploadOptions.success(f)}else{this.uploadOptions.error(this,f);this.modalClose()}}else{this.modalClose();alert("Upload failed!")}}this.el.attr("action",this.element_action);this.el.attr("target","")},draguploadInit:function(g,f){this.draguploadOptions=d.extend({url:false,success:false,error:false,preview:false,uploadFields:false,text:this.opts.curLang.drop_file_here,atext:this.opts.curLang.or_choose},f);if(window.FormData===undefined){return false}this.droparea=d('<div class="redactor_droparea"></div>');this.dropareabox=d('<div class="redactor_dropareabox">'+this.draguploadOptions.text+"</div>");this.dropalternative=d('<div class="redactor_dropalternative">'+this.draguploadOptions.atext+"</div>");this.droparea.append(this.dropareabox);d(g).before(this.droparea);d(g).before(this.dropalternative);this.dropareabox.on("dragover",d.proxy(function(){return this.draguploadOndrag()},this));this.dropareabox.on("dragleave",d.proxy(function(){return this.draguploadOndragleave()},this));this.dropareabox.get(0).ondrop=d.proxy(function(h){h.preventDefault();this.dropareabox.removeClass("hover").addClass("drop");this.draguploadUpload(h.dataTransfer.files[0])},this)},draguploadUpload:function(g){var i=jQuery.ajaxSettings.xhr();if(i.upload){i.upload.addEventListener("progress",d.proxy(this.uploadProgress,this),false)}var h=function(){return i};var f=new FormData();if(this.draguploadOptions.uploadFields!==false&&typeof this.draguploadOptions.uploadFields==="object"){d.each(this.draguploadOptions.uploadFields,d.proxy(function(l,j){if(j!=null&&j.toString().indexOf("#")===0){j=d(j).val()}f.append(l,j)},this))}f.append("file",g);d.ajax({url:this.draguploadOptions.url,dataType:"html",data:f,xhr:h,cache:false,contentType:false,processData:false,type:"POST",success:d.proxy(function(l){l=l.replace(/^\[/,"");l=l.replace(/\]$/,"");var j=d.parseJSON(l);if(typeof j.error=="undefined"){this.draguploadOptions.success(j)}else{this.draguploadOptions.error(this,j);this.draguploadOptions.success(false)}},this)})},draguploadOndrag:function(){this.dropareabox.addClass("hover");return false},draguploadOndragleave:function(){this.dropareabox.removeClass("hover");return false},uploadProgress:function(g,h){var f=g.loaded?parseInt(g.loaded/g.total*100,10):g;this.dropareabox.text("Loading "+f+"% "+(h||""))},isMobile:function(){return/(iPhone|iPod|BlackBerry|Android)/.test(navigator.userAgent)},normalize:function(f){if(typeof(f)==="undefined"){return 0}return parseInt(f.replace("px",""),10)},outerHtml:function(f){return d("<div>").append(d(f).eq(0).clone()).html()},isString:function(f){return Object.prototype.toString.call(f)=="[object String]"},isEmpty:function(f){f=f.replace(/&#x200b;|<br>|<br\/>|&nbsp;/gi,"");f=f.replace(/\s/g,"");f=f.replace(/^<p>[^\W\w\D\d]*?<\/p>$/i,"");return f==""},browser:function(g){var h=navigator.userAgent.toLowerCase();var f=/(chrome)[ \/]([\w.]+)/.exec(h)||/(webkit)[ \/]([\w.]+)/.exec(h)||/(opera)(?:.*version|)[ \/]([\w.]+)/.exec(h)||/(msie) ([\w.]+)/.exec(h)||h.indexOf("compatible")<0&&/(mozilla)(?:.*? rv:([\w.]+)|)/.exec(h)||[];if(g=="version"){return f[2]}if(g=="webkit"){return(f[1]=="chrome"||f[1]=="webkit")}return f[1]==g},oldIE:function(){if(this.browser("msie")&&parseInt(this.browser("version"),10)<9){return true}return false},getFragmentHtml:function(g){var f=g.cloneNode(true);var h=this.document.createElement("div");h.appendChild(f);return h.innerHTML},extractContent:function(){var f=this.$editor[0];var h=this.document.createDocumentFragment();var g;while((g=f.firstChild)){h.appendChild(g)}return h},isParentRedactor:function(f){if(!f){return false}if(this.opts.iframe){return f}if(d(f).parents("div.redactor_editor").length==0||d(f).hasClass("redactor_editor")){return false}else{return f}},currentOrParentIs:function(f){var g=this.getParent(),h=this.getCurrent();return g&&g.tagName===f?g:h&&h.tagName===f?h:false},isEndOfElement:function(){var g=this.getBlock();var i=this.getCaretOffset(g);var h=d.trim(d(g).text()).replace(/\n\r\n/g,"");var f=h.length;if(i==f){return true}else{return false}},isFocused:function(){var f,g=this.getSelection();if(g&&g.rangeCount&&g.rangeCount>0){f=g.getRangeAt(0).startContainer}if(!f){return false}if(this.opts.iframe){if(this.getCaretOffsetRange().equals()){return !this.$editor.is(f)}else{return true}}return d(f).closest("div.redactor_editor").length!=0},removeEmptyAttr:function(g,f){if(d(g).attr(f)==""){d(g).removeAttr(f)}},removeFromArrayByValue:function(h,g){var f=null;while((f=h.indexOf(g))!==-1){h.splice(f,1)}return h}};c.prototype.init.prototype=c.prototype;d.Redactor.fn.formatLinkify=function(t,q,j,o){var p=/(^|&lt;|\s)(www\..+?\..+?)(\s|&gt;|$)/g,m=/(^|&lt;|\s)(((https?|ftp):\/\/|mailto:).+?)(\s|&gt;|$)/g,f=/(https?:\/\/.*\.(?:png|jpg|jpeg|gif))/gi,s=/^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;var r=(this.$editor?this.$editor.get(0):this).childNodes,h=r.length;while(h--){var g=r[h];if(g.nodeType===3){var l=g.nodeValue;if(o&&l&&l.match(s)){l=l.replace(s,'<iframe width="560" height="315" src="//www.youtube.com/embed/$2" frameborder="0" allowfullscreen></iframe>');d(g).after(l).remove()}else{if(j&&l&&l.match(f)){l=l.replace(f,'<img src="$1">');d(g).after(l).remove()}else{if(q&&l&&(l.match(p)||l.match(m))){l=l.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(p,'$1<a href="'+t+'$2">$2</a>$3').replace(m,'$1<a href="$2">$2</a>$5');d(g).after(l).remove()}}}}else{if(g.nodeType===1&&!/^(a|button|textarea)$/i.test(g.tagName)){d.Redactor.fn.formatLinkify.call(g,t,q,j,o)}}}}})(jQuery);